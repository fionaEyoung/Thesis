
\section{Validation: Methods}

Segmentation tasks are commonly validated against reference data using a single numeric score of similarity or accuracy.
In the absence of a ground truth for \textit{in vivo} white matter tracts, what should instead by the measure by which a tract imaging method is considered ``accurate''?
Perhaps the only reasonable performance target can be to reproduce as closely as possible the results which would be obtained by the current standard, which in most cases would be streamline tractography.
However, given the very large degree of variability between tractography algorithms and tract reconstruction approaches, even this is a poorly defined reference point.
False positive streamlines can unfairly skew accuracy scores, while manually editing reference bundles to remove them is likely to introduce bias.

Given these challenges, we'll aim to present as rounded a picture as possible of the differences and characteristic features of each method through different volumetric and distance-based similarity metrics.
The purpose of this validation is not to determine which method is best, as indeed cannot be determined without a reliable reference point, but to highlight the ways in which they are similar, and their strengths and weaknesses.

\subsection{Benchmark methods}
\label{sec:methods}

We'll consider three alternative tract segmentation approaches and compare each with tractfinder: Probabilistic streamline tractography, representing the current standard, the deep learning direct segmentation technique TractSeg, and a ``naive'' atlas registration.
There are numerous alternative techniques, as detailed in Chapter \ref{chap:neuroimaging}, many based on streamline clustering or classification, or automatic \gls{roi} registration, including White Matter Analysis (WMA)\autocite{ODonnell2017}, RecoBundles \autocite{Garyfallidis2018}, Classifyber\autocite{Berto2021}, and Tracula\autocite{Yendiki2011}.
We will not be comparing tractfinder with all of these alternatives because such a comparison would hardly provide any additional useful information:
In those methods which rely on a predefined atlas of streamlines or \glspl{roi}, the anatomical assumptions embedded in those predefinitions would influence the similarity metrics more than any methodological differences, as indeed they do for the comparisons with TractSeg that follow.
Furthermore, many of those alternatives have already been systematically compared with TractSeg\autocite{Wasserthal2018,Berto2021}, and so in comparing tractfinder with the latter we can infer relative performance against them.

\paragraph*{Streamline tractography}

Targeted probabilistic streamline tractography (iFOD2 algorithm\autocite{Tournier2010}, from MRtrix3\autocite{Tournier2019} v3.0.3)  was run in each scan using a multi-\gls{roi} approach (see \ref{app:rois} for \gls{roi} details), with tractography input \glspl{fod} derived from \gls{msmt} \gls{csd} \autocite{Jeurissen2014} using \gls{wm} and \gls{gm} tissue compartments.
In the clinical dataset, \glspl{roi} were placed manually for each subject.
For the 184 \gls{hcp} and \textit{TractoInferno} subjects, manual \gls{roi} placement was infeasible.
Instead the same \glspl{roi} were drawn in MNI152 template space aided by the \gls{fsl} \gls{hcp}-1065 \gls{dti} template\autocite{FSLATLAS} and transformed to subject space using non-linear registration
(\gls{hcp} data includes MNI transformation warps, while warps were created for the \textit{TractoInferno} data using the ANTs registration package v2.4.2 (http://stnava.github.io/ANTs/) \autocite{Tustison2013,Avants2011}.

The anatomical definitions informing the manual tractography paradigm was the same as for creating the respective atlases, however, to avoid dependence on resource-intensive tools for cortical parcellation, only white matter \glspl{roi} could be used.
The result is generally more extensive cortical terminations into gyri and sulci, for example in the \gls{af} and \gls{ifof}, not otherwise included in the atlases due to either the use of cortical \glspl{roi} or extensive manual filtering, while the core subcortical portions match the definitions reflected in the atlases.
The same \gls{wm} seed and inclusion \glspl{roi} used for the atlases were adopted, along with additional exclusion \gls{roi} where necessary.
For a full description of all tractography \glspl{roi} and any differences between atlas streamlines and validation manual tractography, see Appendix \ref{app:rois}
This manual tractography (using the same anatomical definitions as the atlases) is subsequently abbreviated to ``\gls{tg}'', while the reference \textit{TractoInferno} bundles (produced using RecoBundlesX, see Section \ref{sec:data}) are referred to as ``\gls{tgr}''.
Since tractfinder is a voxel-based method, streamlines were converted to voxel-based representation via \gls{tdi}\autocite{Calamante2010}, producing maps of streamline density per voxel.

\paragraph*{TractSeg}

TractSeg \autocite{Wasserthal2018} is a deep convolutional neural network model for tract segmentation which produces volumetric segmentation for 72 tracts directly from fibre orientation distribution peak directions (TractSeg v2.3--2.6, available at \url{https://github.com/MIC-DKFZ/TractSeg}).
There are two models available: One trained on modified streamline reconstructions using TractQuerier \autocite{Wassermann2016} as described in \textcite{Wasserthal2018} (``\gls{tsd}''), and a second trained on streamline density maps output by \gls{fsl}'s XTRACT \autocite{Warrington2020} application using automatic predefined \gls{roi} registration and probtracx probabilistic tractography\autocite{Behrens2007} (``\gls{tsx}'').
Here both versions are compared, as they feature significant differences in anatomical tract definitions.
Input peaks for all TractSeg results were derived from the \gls{ssst} \gls{csd} \glspl{fod} for all single-shelled data and from the \gls{msmt} peaks for all multi-shelled data.

\paragraph*{Atlas registration}

As well as the full tractfinder method (atlas alignment and inner product), we'll also consider a ``naive'' tract atlas approach, using only the density component (first \gls{sh} coefficient) of the linearly registered tract atlases without any comparison with the native \glspl{fod}.
This amounts to a segmentation based on prior spatial expectation only, without taking into account the diffusion data or orientation expectations, and is comparable with segmentation approaches that rely entirely on registration, such as common cortical parcellation tools.
Comparing results with simple atlas registration between structural image data is instructive for determining the added value of utilising \gls{dmri} data to inform segmentation, which may be relevant to future investigations into the benefits of acquiring intraoperative \gls{dmri} in addition to conventional tissue contrast \gls{mri} sequences.

\subsection{Comparison metrics}

Each technique is compared against all others, rather than designating any single technique as ``ground truth'', with the exception of the \textit{TractoInferno} dataset, where the published streamlines are treated as an independent reference.
Several comparison metrics are computed, to capture different aspects of agreement between segmentations.
The \gls{dice} \autocite{Dice1945} is a popular, symmetric measure of segmentation similarity given by

\begin{align}
  DSC &= \frac{2 |A \cap B|}{|A| + |B|}
\end{align}

for two binary voxel sets $A$ and $B$.
Since \gls{dice} is a measure for binary segmentations, it requires the thresholding of continuous-valued maps such as track density maps and the pseudo-probability maps produced by tractfinder, which poses some problems.
Firstly, the conversion from continuous-valued to binary representation introduces a high degree of ambiguity over the appropriate choice of threshold value.
While the simplest and least ambiguous approach may be to include all non-zero valued voxels in the segmentation, this makes little sense in practice.
In the case of tractography, a small number of stray false positive streamlines can substantial increase the thresholded volume, and in the case of TractSeg, very few voxels actually have an inference probability of 0.
The thresholds used wherever binary segmentations are concerned are given in Table \ref{tab:thresh}.
Secondly, the binary nature of a \gls{dice} discounts the additional confidence information present in density and probability maps.
Assigning equal weight to a segmentation voxel only marginally above threshold and that with the highest overall value doesn't provide a fair assessment of a method's performance and leads to tract maps which are visually harder to interpret.

\begin{table}[h!]
  \caption{Intensity thresholds for binary comparison measures.}
  \label{tab:thresh}
  \small
  \begin{tabularx}{\textwidth}{>{\raggedright\arraybackslash}X l >{\raggedright\arraybackslash}X}
    \toprule
    Method    & Threshold value & Reasoning \\
    \midrule
    Tractfinder   & 0.05 & empirically determined \\
    Tractography (streamline density) & 10 & enough exclude obvious false positives \\
    Reference tractography (\textit{TractoInferno} only) & 0 & Assume no false positives \\
    Atlas         & 0.1 & double the tractfinder value, as the inner product roughly halves the atlas values \\
    TractSeg      & 0.5 & consistent with default TractSeg settings \\ \bottomrule
  \end{tabularx}
\end{table}

In addition to the binary \gls{dice} measure, we therefore utilise the density correlation as a measure of volumetric agreement between two continuous valued segmentations, which is simply the Pearson correlation coefficient between the two sets of voxel values, and has been used in other studies to compare streamline density volumes\autocite{Radwan2022, Schilling2021a}.

In addition to the volumetric overlap and density metrics, the volumetric bundle adjacency as defined in \textcite{Schilling2021a} is also measured.
However, to avoid confusion with the streamline-based bundle adjacency\autocite{Radwan2022, Garyfallidis2012, Rheault2022} metric previously defined in \textcite{Garyfallidis2012},
and to give more intuitive meaning to the obtained values, we will refer to it as bundle distance ($BD$).
It is computed by taking the mean of minimum distances from every non-overlapping voxel, in each segmentation, to the closest voxel in the other segmentation (Fig. \ref{fig:BD}):
\begin{align}
  BD(A,B) &= \frac{\sum_{i \in A\setminus B} d_i(B) + \sum_{i \in B\setminus A} d_i(A)}{|A\Delta B|} \label{eq:bd}.
\end{align}
where $| \cdot |$ denotes set cardinality, $\setminus$ denotes the set difference, and $d_i(X)$ is the Euclidean distance transform (defined relative to the foreground of segmentation $X$, i.e. $d_i(X) = 0$ when $i \in X $ and $d_i(X) = |\overrightarrow{ij}|$ when $i \not\in X$ and where $j \in X$ is the voxel in $X$ closest to voxel $i$)  of segmentation $X$ at voxel $i$.
Finally, to give a sense of whether the boundary of one segmentation is primarily within or outside that of a second segmentation, we'll also consider the \textit{signed} bundle distance ($BD_s$).
This metric is asymmetric, with $BD_s (A,B) = -BD_s(B,A)$, and is defined as

\begin{align}
  BD_s(A,B) &= \frac{\sum_{i \in A\setminus B} - d_i(B) + \sum_{i \in B\setminus A} d_i(A)}{|A\Delta B|}. \label{eq:bds}
\end{align}

\begin{SCfigure}[50][htbp!]
  \centering
  \includegraphics[width=0.3\textwidth]{chapter_5/segmentations_distance_euc.pdf}
  \caption[Bundle distance calculation]{Illustration of regions involved in calculating bundle distance metric. The light grey area is $A\setminus B$, dark grey is $B\setminus A$, and in each grey voxel is written its minimum Euclidean distance to the black intersection. Distance sign is negative outside of the reference segmentation ($B$ in this example) and positive inside. To compute the bundle distance $BD(A,B)$ (Eq. \ref{eq:bd}), the mean minimum absolute distance is taken across all 17 voxels in the two grey areas $BD(A,B) = (14+4\sqrt{2}+3\sqrt{5})/17 = 1.55$. To compute the signed bundle distance $BD_s(A,B)$ (Eq. \ref{eq:bds}), the signed distances relative to the reference set $B$ are used: $BD_s(A,B) = (2-2\sqrt{2}-\sqrt{5})/17 = -0.18$. The \gls{dice} for these two segmentations would be $DSC = 2*4/(13+12) = 0.32$}
  \label{fig:BD}
\end{SCfigure}

\section{Pairwise benchmark evaluation}
\label{sec:validation}

In the following section, we will review the results of quantitatively comparing each of the methods described in Section \ref{sec:methods}, in the HCP49, clinical, and TractoInferno datasets, including material which has been accepted for publication in \textit{Human Brain Mapping}\autocite{Young2024}.
Given the large disparities in tract anatomical definitions between methods, the results presented in this section can be regarded as a quantitative performance evaluation against benchmark methods.
In a subsequent section (\ref{sec:tractseg}) we will see how the two method tractfinder and TractSeg compare when both are trained on the same data.

Segmentation results results for a representative subject from the \textit{TractoInferno} dataset are shown in Figures \ref{fig:lb.cstor}--\ref{fig:lb.afifof}.
Tractfinder maps typically have values ranging from 0 to 0.5 (in arbitrary units, derived from the magnitudes of \gls{fod} and atlas distribution functions).
Due to the combined effects of \gls{odf} amplitude and orientation information, a low tract map value can have several causes: a) the \gls{fod} amplitude is low, indicating low evidence for white matter tissue in the voxel in question; b) the atlas amplitude is low, indicating low prior likelihood of the tract being present in that location; c) the peak orientations between the \gls{fod} and atlas are poorly aligned.

Thus combining information from the atlas and data-derived \glspl{fod} improves the tract map estimation over the ``raw'' registered atlas in both the spatial and orientational domain. For example, the \gls{tod} atlases have poor definition of gyri and sulci, due to the effect of averaging over many subjects and linear registration. The reduced overall \gls{fod} amplitude in grey matter corrects this non-specificity. And in regions where different white matter structures lie in close proximity, where the atlas can erroneously predict the likely presence of the tract, and \gls{fod} amplitude is high, the lack of orientational agreement discounts the presence of the tract of interest in that location.

% Fullpage figures
\begin{figure}[htb!]
  \begin{subfigure}{\textwidth}
    \makebox[\linewidth][r]{%
    \includesvg[width=\textwidth,pretex=\sffamily\footnotesize]{chapter_5/LB_AF.svg}}
  \end{subfigure}
  \begin{subfigure}{\textwidth}
    \makebox[\linewidth][r]{%
    \includesvg[width=\textwidth,pretex=\sffamily\footnotesize]{chapter_5/LB_IFOF.svg}}
  \end{subfigure}
  \caption[AF and IFOF tract segmentations in all benchmark evaluation methods]{Segmentations for the left \gls{af} (top) and \gls{ifof} (bottom) in a representative subject from the \textit{TractoInferno} dataset, shown on slices at 5~mm intervals and as volumes in the last column. Segmentations have been thresholded according to Table \ref{tab:thresh}, and colourbars are drawn once for each method category (tractfinder, tractography and TractSeg).}
  \label{fig:lb.afifof}
\end{figure}
\begin{figure}[htb!]
  \centering
  \begin{subfigure}{\textwidth}
    \makebox[\linewidth][r]{%
    \includesvg[width=\textwidth,pretex=\sffamily\footnotesize]{chapter_5/LB_CST.svg}}
  \end{subfigure}
  \begin{subfigure}{\textwidth}
    \makebox[\linewidth][r]{%
    \includesvg[width=\textwidth,pretex=\sffamily\footnotesize]{chapter_5/LB_OR.svg}}
  \end{subfigure}
\end{figure}
\clearpage %flush
{\captionof{figure}[CST and OR tract segmentations in all benchmark evaluation methods]{Segmentations for the the projection tracts \gls{cst} (top) and \gls{or} (bottom) in a representative subject from the \textit{TractoInferno} dataset shown on slices at 5~mm intervals and as volumes in the last column. Segmentations have been thresholded according to Table \ref{tab:thresh}, and colour scales are drawn once for each method category (tractfinder, tractography and TractSeg). \label{fig:lb.cstor}}
}
\subsection{Quantitative results}\label{sec:quant}

\begin{figure}[h!]
  \centering
  \makebox[\linewidth][r]{%
  \includegraphics{chapter_5/TI_boxplots.pdf}}
  \caption[Comparison results with \textit{TractoInferno} reference streamlines]{All methods compared against the \textit{TractoInferno} reference streamlines. \acrolist{af, cst, or, ifof, tf, at, tsx, tsd, tgr}}
  \label{fig:combobox}
\end{figure}

\paragraph*{Performance and reproducibility}

\begin{SCfigure}
  \includegraphics{chapter_5/score_mats_group.pdf}
  \caption[Pairwise DSC and density correlations for the \textit{TractoInferno}, HCP, and clinical datasets]{Pairwise \gls{dice} and density correlations for the \textit{TractoInferno} (top) HCP49 (middle) and clinical (bottom) datasets. For each pair of methods, the metric distributions across all subjects are shown for each tract (from left to right: \gls{af}, \gls{cst}, \gls{ifof}, \gls{or}), with background colours corresponding to mean score value. \acrolist{af, cst, or, ifof, tf, at, tsx, tsd, tgr}
  \label{fig:dscmats}}
\end{SCfigure}

In a realistic clinical context, our target segmentation is represented not by an independently determined and verifiable ground truth, but by the results of whatever approach would normally be taken to produce tract reconstructions for surgical guidance in the absence of any suitable alternative.
That benchmark is targeted multi-\gls{roi} streamline tractography, against which we need to evaluate tractfinder.
At the same time, quantitative evaluation using tractography as a reference is problematic as with typical use tractography will produce many false positives that are easily mentally discounted by an experienced viewer, but which will confound quantitative accuracy metrics.


This is one reason why the density correlation metric is particularly useful for comparing methods in this task:
False positive streamlines are more likely to be apparent in areas of low streamline density, and if the compared segmentation correspondingly predicts a low probability in the same areas, then this will be consistent with a high correlation value.
The density correlation thus helps illustrate the cases where the choice of threshold may have a disproportionate influence on subsequent binary comparisons.
For example, in the \gls{hcp} dataset and for the corticospinal tract, mean \gls{dice} was $0.69$ between tractfinder and tractography and $0.51$ between TractSeg XTRACT and tractography (a difference of $0.18$).
For the same two comparisons, the density correlations differed only by $0.04$ ($0.63$ and $0.59$) respectively, indicating strong agreement about areas with high and low tract probabilities, with slight differences in cutoff value likely contributing to the larger disparity in \gls{dice} scores (Fig. \ref{fig:dscmats}).


The signed bundle distance gives an indication of the nature of disagreement between two techniques where other metrics show little difference.
For example, in the \textit{TractoInferno} dataset and for the \gls{af}, mean bundle distance to targeted tractography was 5.06~mm for the naive registered atlas and a very similar 5.07~mm TractSeg DKFZ at (Fig. \ref{fig:combobox}). % (Tab. \note{missing table tab:DATAHCP}).
However, the signed bundle distances for those same two comparisons were +1.65~mm and -2.60~mm respectively (similar values were also found for the \gls{hcp} dataset, data not shown here).
This indicates that, while if only considering the bundle distance metric, both TractSeg and the atlas appear to agree to a similar degree with tractography, TractSeg actually systematically over-segments the \gls{af} (relative to tractography), while the naive atlas segmentation tends towards under-segmentation.

With all this in mind, we find that tractfinder does indeed reliably perform well against targeted streamline tractography across all metrics, with the exception of the \gls{af} when measured on \gls{dice} or distance metrics.
There are a couple possible factors which may account for the worse performance for the \gls{af}.
One is the difficulty in consistently reconstructing this tract, as well as the \gls{ifof}, using only \gls{wm} based \glspl{roi} (as opposed to cortical \glspl{roi} which necessitate more extensive image preprocessing), which are unable to adequately constrain the streamlines as they fan out into numerous cortical regions.
Supporting this theory, tractfinder returned the highest standard deviation values for the \gls{af} out of all four tracts across all metrics except the signed bundle distance.
It should be noted that, compared to tractography, TractSeg also returns higher standard deviations for the \gls{af}, pointing to an inter-subject variability in tractography segmentations, rather than an high degree of inconsistency in tractfinder performance.
We can also see that the signed bundle distance is significantly higher on average for the \gls{af} and \gls{ifof} (Fig. \ref{fig:hcpbox}), meaning tractfinder typically under-segments these tracts relative to tractography, which is to be expected with large numbers of streamlines fanning to adjacent cortical termini not included in the curated tract atlas.
Another potentially contributing factor is the \gls{af}'s unique shape, which features a tight bend around the top of the Sylvian fissure.
Alignment of an atlas with this shape is particularly sensitive to individual anatomical variations which may also partly explain the lower average accuracy for this tract.

\begin{SCfigure}
  \includegraphics{chapter_5/hcp_box.pdf}
  \caption[Signed bundle distances to streamline tractography, HCP dataset]{Signed bundle distances for all methods compared against targeted tractography in the \gls{hcp} dataset. \acrolist{af, cst, or, ifof, tf, at, tsx, tsd, tgr}}
  \label{fig:hcpbox}
\end{SCfigure}

Notwithstanding the slightly worse accuracy for the \gls{af} and to a lesser extent the \gls{ifof}, on balance we can see that tractfinder returns consistently strong agreement with tractography across all metrics.
We also observe a low degree of variability in tractfinder scores against benchmark methods, indicating consistent performance.
There is little variation in results across subjects, and the overall patterns also remain consistent between the different datasets, both healthy and clinical, which feature a range of acquisition parameters and ages.

As a final comment on reproducibility, we note that the results in Figure \ref{fig:combobox} agree with values published in \textcite{Wasserthal2018}.
There, a mean \gls{dice} of between 0.58 and 0.67 across all tracts was reported for RecoBundles evaluated against the TractQuerier derived reference bundles.
Our measured \glspl{dice} between TractSeg DKFZ and TractoInferno reference bundles (which is based on RecoBundlesX) range between 0.45 and 0.66 across the four tracts studied, demonstrating consistency between the two in different datasets.

\paragraph*{Tract variability}

Visual assessment reveals that systematic differences in the shapes of the segmented tracts account for a large part of the discrepancy between methods.
Again, this is most apparent in the association tracts, where anatomical definitions differ widely (Fig. \ref{fig:lb.cstor}--\ref{fig:lb.afifof}).
For example, TractSeg DKFZ includes extensive coverage of the frontal and temporal lobe in its \gls{af} segmentations, including parts of the primary motor cortex.
\Glspl{dice} between different methods are lower across the board for the \gls{af} owing to these anatomical disagreements.
Similarly, the \gls{ifof} reconstructions also display strong variability, owing in part to disagreements in its precise definition as reviewed in Chapter \ref{chap:atlas}.
Conversely in the \gls{cst}, which has a relatively well agreed-upon domain, segmentations have much higher volumetric agreement between methods, with the exception of TractSeg XTRACT, which does not include the lateral projections (Fig. \ref{fig:lb.cstor}).
Agreement in the optic radiations is somewhere in between, with slightly lower \glspl{dice} in tractfinder compared against the two TractSeg methods, which tend to include more thalamus and a lesser extent of Meyer's loop.
These differences highlight the difficulty in assessing the ``accuracy'' of white matter segmentation methods given limited consensus on the precise anatomical definitions of different pathways.

A further consideration is the effect of segmentation volume on \gls{dice} values.
This metric is more sensitive to segmentation errors in smaller volumes, and conversely segmentations of large structures tend to score higher.
We can see this particularly well in TractSeg DKFZ's results when compared with reference tractography in the TractoInferno data, which was produced using the streamline clustering tool RecoBundlesX\autocite{Garyfallidis2018,Rheault2020a}.
In Figure \ref{fig:combobox}, TractSeg scores notably high against the TractoInferno reference bundles, for the \gls{ifof} and \gls{af}, both association bundles whose cortical terminations are poorly defined.
As reviewed in Chapter \ref{chap:atlas}, contemporary controversies surrounding the \gls{af} include proposals that it terminates in the motor or pre-motor cortex instead of Broca's area in the inferior frontal gyrus, and that its temporal terminations extend beyond Wernicke's area into the superior, middle and inferior temporal gyri\autocite{Dick2012,Giampiccolo2022a}.
Both TractSeg DKFZ\autocite{Wasserthal2018c} and the RecoBundlesX atlas\autocite{Rheault2021} have adopted a more permissive model of the \gls{af}, selecting streamlines visiting any of the inferior frontal, middle frontal, and precentral gyri, and all of the temporal lobe, producing large bundles and favourable \gls{dice} results.
This contrasts with the bundle distance and density correlation metrics, where the differences between TractSeg (DKFZ) and other methods are no more pronounced for the \gls{af} than in the other tracts.2
% Consequently, streamline tracking, lacking appropriate cortical constraints, may reconstruct bundles with large and variable volumes (Fig. \note{ref:lightbox ifof and af}).
% Both RecoBundlesX and TractQuerier (the basis for the DKFZ reference bundles) generate individual bundles from whole-brain tractograms
% \note{something about how this makes dice scores dodgy, compare with e.g. other metrics, same advantage not there (hcp) compared with targeted tractography}
% Figure \ref{fig:combobox} compares each studied method against the reference streamline bundles in the \textit{TractoInferno} dataset.
% Noticeably, the differences in scores within a single method, between different tracts, are in places greater than the differences between methods within a tract.
% For example, the binary \gls{dice} scores for the \gls{cst} are similar for tractfinder and TractSeg (DKFZ) ($0.48$ and $0.45$ on average respectively), however the binary \glspl{dice} of TractSeg (DKFZ) are markedly different between the \gls{cst} and \gls{or} ($0.45$ and $0.59$ on average respectively). % This is all based on the TGR comparison, which have decided isn't very helpful anyway. Against the TG comparison, in \gls{hcp} and TI data, this observation goes away

\paragraph*{TractoInferno reference bundles}

% \textit{\gls{dice}, \gls{gdice} and density correlation values for tractfinder were on par with TractSeg (XTRACT) in all four tracts, with the exception of density correlation in \gls{af}, while \gls{gdice} and density correlation were higher than TractSeg (DKFZ) in all tracts.
% Binary \gls{dice} scores were highest for TractSeg (DKFZ) in the \gls{cst} and \gls{af}, and equal between tractography, tractfinder and TractSeg (DKFZ)  for the optic radiation.}

Initially intending to make use of the published \textit{TractoInferno} streamlines as an unbiased reference for comparison, upon closely examining the results it became apparent that they were unsuited for this application.
Regardless of tract, metric, or compared methods, the \textit{TractoInferno} reference streamlines yielded variable results with large numbers of outliers (Fig. \ref{fig:combobox}).
Further investigation into these outliers revealed numerous subjects with incomplete or highly asymmetric bundles, this despite strict quality control \autocite{Poulin2022a}.
For example, in several cases, optic radiation streamlines only reach the superior portion of the occipital lobe (Fig. \ref{fig:duds}).
In others, the right arcuate fasciculus is significantly smaller than the left (Fig. \ref{fig:duds}).

\begin{figure}
  \centering
  \includegraphics[width=\textwidth]{chapter_5/badti.png}
  \caption[Incomplete bundles in the \textit{TractoInferno} reference data]{Incomplete and conspicuously asymmetric \gls{af} (top row) and \gls{or} (bottom row) bundles in the \textit{TractoInferno} dataset. Examples shown from subjects 1078, 1117, 1114, 1131, 1222, 1170, and 1088.}
  \label{fig:duds}
\end{figure}

Given these inconsistencies, a critical analysis on the relative performances of the different segmentation approaches against the \textit{TractoInferno} reference streamlines was ruled out.
The \textit{TractoInferno} dataset features 284 subjects in total (71 were used for the present analysis), and was published with the intention of providing a large and high quality dataset of reference streamlines explicitly for the purpose of training deep learning models for improved tractography and other data-intensive applications.
Of the full dataset, only 80 subjects were found to have all four tracts studied here available, and a query of the public database\autocite{Poulin2022a} indicates that of the 30 reconstructed bundles, only 24 bundles were retained on average per subject after quality control.
The inconsistent quality of these bundles highlights the difficulty in producing streamline tractography bundles with a high degree of anatomical fidelity and inter-subject consistency in so many individuals.
The reliance on such large datasets thus presents a significant challenge to deep machine learning methods and demonstrates the advantage of an approach like tractfinder, as was seen in (\ref{sec:ntrain}).

\paragraph*{Clinical applicability (GOSH \& NHNN)}

The present analysis includes clinical scans with non-deforming lesions, meaning the orientation atlas could be registered to the target image using only affine registration without the need for tumour deformation modelling.
For results in clinical scans featuring deforming lesions, see Sections \ref{sec:btcd} and \ref{sec:imri}. %\textcite{Young2022}
Overall, quantitative results in the clinical (\gls{gosh} \& \gls{nhnn}) dataset were highly consistent with those seen in the healthy datasets.
Although this dataset contained a mixture of adult and paediatric patients, scanned at two different hospitals, when the results were split on hospital / age group (paediatric or adult), no appreciable difference in results was observed.
Equally, no systematic difference in segmentation scores was observed between intraoperative and preoperative datasets.

Two example clinical subjects, one adult and one paediatric, are displayed in Figures \ref{fig:lb.nh}--\ref{fig:lb.gosh} and demonstrate key observations in the clinical applicability of the compared methods.
In Figure \ref{fig:lb.nh}, a sagittal view displays the interaction between the surgical resection cavity of a frontal tumour and the \gls{cst}.
Tractfinder maps portions of the \gls{cst} in close proximity to the resection site, as does manual tractography, where the TractSeg segmentations are far more conservative and even incomplete, potentially missing \gls{cst} locations influenced by oedema, brain shift, or other tumour effects.
Even though parts of the precentral sulcus remain some distance from the resection site, the slight brain shift may have affected TractSeg's ability to fully recognise the \gls{cst}.
Intraoperative imaging of a paediatric tumour patient in Figure \ref{fig:lb.gosh} reveals the ipsilateral \gls{or} immediately deep to the resection cavity.
Minimal brain shift and diffusion disturbance from this small craniotomy have enabled good reconstruction of the affected tract by all techniques.
The anterior extent of Meyer's loop has additionally been captured by tractography and tractfinder, but is absent from both TractSeg results.
Further examples of tract reconstructions in intraoperative imaging are displayed in Figure \ref{fig:tumours}, panels c and e.

\begin{figure}[htb!]
  \makebox[\linewidth][r]{%
  \includesvg[width=\textwidth,pretex=\sffamily\footnotesize]{chapter_5/LB_NHNN_5.svg}}
  \caption[CST segmentations in all benchmark evaluation methods for an adult intraoperative case in the clinical dataset]{Intraoperative imaging for an adult right frontal \gls{who} grade 2 oligodendroglioma patient from the clinical dataset, with right \gls{cst} segmentations (thresholded according to Table \ref{tab:thresh}) shown in coronal slices at 5~mm intervals and as full volumes in the right-most column. White arrowheads indicate the precentral sulcus.}
  \label{fig:lb.nh}
\end{figure}
\begin{figure}[htb!]
  \makebox[\linewidth][r]{%
  \includesvg[width=\textwidth,pretex=\sffamily\footnotesize]{chapter_5/LB_GOSH_3.svg}}
  \caption[OR segmentations in all benchmark evaluation methods for a paediatric intraoperative case in the clinical dataset]{Intraoperative imaging for a paediatric temporal diffuse low-grade astrocytoma patient, with bilateral \gls{or} segmentations (thresholded according to Table \ref{tab:thresh}) shown in axial slices at 5~mm intervals and as full volumes in the right-most column.}
  \label{fig:lb.gosh}
\end{figure}

% The mean score results for all tracts and comparisons are given in Supplementary Table \note{tab:DATACL}.

\subsection{Processing times}

A full processing time breakdown is presented in Table \ref{tab:time}.
Atlas transformation and inner product computation time per subject for all four tracts and both hemispheres was 24~$\pm$~5~s, plus 1--2~minutes for \gls{msmt}-\gls{csd} and 20~seconds for MNI registration, with an average total time of just under 3~minutes for the entire tractfinder pipeline (Tab. \ref{tab:time}).
For TractSeg, mean processing time (for all tracts, 72 for DKFZ and 23 for XTRACT, both hemispheres) was 4:00~$\pm$~1:00~minutes, plus 15--20~sseconds for \gls{ssst}-\gls{csd}.

For manual streamline tractography in the clinical datasets, processing time was not explicitly measured, due to the high variability that comes with manual \gls{roi} drawing (between 10--25 minutes for all tracts in a single subject, although anecdotally this varies significantly between operators).
\Gls{hcp} and \textit{TractoInferno} tractography was run on a high performance computing cluster, taking approximately ten seconds per tract (single hemisphere), using 36 CPU cores, and additionally up to 2~minutes for non-linear \gls{roi} registration (Table \ref{tab:time}).
However, since the time taken depends greatly on several factors, including number of streamlines to select and streamline acceptance rate (often low in brains with pathology due to oedema, deformation etc.), a precise time analysis for manual tractography cannot provided here.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{table*}[h!]
  \caption[Measured preprocessing times for different tract segmentation pipelines]{Measured processing times mean and standard deviation for \textit{TractoInferno} dataset. Individual steps shown and total average for the four different pipelines. Note that the tractography pipeline was partially run on a high performance computing cluster, so the reported total time is not representative of a typical setup. Further note that for the present study, tractography \glspl{roi} were drawn once for the whole dataset, whereas for clinical datasets manual \gls{roi} delineation will have to be repeated for each subject. \dag Desktop Mac with 4 GHz Quad-Core Intel Core i7 \ddag High performance computing cluster, one node per subject, 36 Intel(R) Xeon(R) Gold 6240 CPU @ 2.60 GHz cores per node.}
  \label{tab:time}
  \small
  \begin{tabularx}{\textwidth}{>{\raggedright}X >{\centering}X ^>{\sffamily}c ^>{\sffamily}c ^>{\sffamily}c ^>{\sffamily}c}
    \toprule
    \rowstyle{\rmfamily}
    Step & Processing time\newline(s, per subject) & Tractfinder & TractSeg & Atlas & Tractography \\
    \midrule
    \dag Brain masking & 3 $\pm$ 2 &\x{}&\x{}&\x{}&\x{}\\
    \dag Affine MNI registration & 20 $\pm$ 4 &\x{}&  &\x{}&  \\
    \dag Response function & 5 $\pm$ 3 &\x{}&\x{}&\x{}&\x{}\\
    \dag MSMT CSD & 110 $\pm$ 55 &\x{}&  &\x{}&\x{}\\
    \dag SSST CSD + peaks estimation & 18 $\pm$ 8 &  &\x{}&  &  \\
    \dag Atlas transformation + inner product (4 tracts, 2 hemispheres) & 24 $\pm$ 5 &\x{}&  & (\x{}) &  \\
    \dag TractSeg DKFZ / XTRACT (72 / 23 tracts) & 240 $\pm$ 60 &  &\x{}& & \\
    \dag Manual \gls{roi} delineation (once for whole dataset) & 1200 & & & &\x{}\\
    \ddag Non-linear \gls{roi} registration + tractography (4 tracts, 2 hemispheres) & 334 $\pm$ 163 & & & &\x{}\\ \addlinespace
    \rowstyle{\bfseries\rmfamily}
    Total &  & 2:42~min & 4:25~min & \textless2:42~min & \textgreater 27:32~min \\ \bottomrule
  \end{tabularx}
\end{table*}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%

\section{Two methods, same training data}\label{sec:tractseg}

A key component of tractfinder is the precise definition of each tract and careful filtering of atlas training streamlines.
Despite the availability of public streamline datasets including the \textit{TractoInferno} data and the TractSeg training and validation bundles, none were found to adequately fulfil the predefined anatomical criteria, and thus new training streamlines were generated for tractfinder.
While the anatomical fidelity of the resulting atlases represents a particular strength, it does make objective comparison between benchmark methods, which may be based on different references, difficult.
In order to produce a direct and objective comparison with TractSeg, a new set of tract atlases were created from the TractSeg DKFZ reference bundles\autocite{Wasserthal2018b} in the HCP105 dataset, using the same split into training and testing subjects as used in the deep learning model (published version).
TractSeg was trained on 63 subjects and tested on the remaining 42, and here the same was done for tractfinder (where ``training'' means constructing the atlas from individual bundles as described in Chapter \ref{chap:atlas}), even though tractfinder atlases can be constructed from just 10-15 subjects (see \ref{sec:ntrain}).
Since the original TractSeg paper includes 72 tracts (including both left and right instances of non-commissural tracts and multiple subdivisions of tracts such as the corpus callosum or anterior thalamic radiation) and the performance varied substantially across tracts, tractfinder was run for all tracts for completeness rather than just the four (\gls{af}, \gls{cst}, \gls{ifof}, \gls{or}) studied thus far.

\begin{figure}[htb!]
  \makebox[\linewidth][r]{%
  \includegraphics{chapter_5/ts_test_box.pdf}}
  \caption[Direct comparison between tractfinder and TractSeg, all metrics]{Scores for tractfinder (using atlases constructed from the TractSeg training data) and TractSeg validated on the TractSeg reference bundles.}
  \label{fig:ts_atlas}
\end{figure}

In the four main tracts (\gls{af}, \gls{cst}, \gls{ifof}, \gls{or}) Tractfinder scores equally well or better on all volumetric overap and distance metrics with the exception of the \gls{dice}, where in particular the scores for the \gls{ifof} and \gls{or} are lower (Fig. \ref{fig:ts_atlas}).
These results clearly demonstrate that for clinically relevant large \gls{wm} tracts, tractfinder is an accurate alternative to TractSeg while maintaining additional advantages in flexibility, robustness and explainability.
The \gls{dice} scores and density correlations for all 72 tracts are shown in Figure \ref{fig:ts_all_tracts}, analogous to Figure 6 in \textcite{Wasserthal2018}.
Neither method convincingly outperforms the other, although TractSeg does score higher when measured by \gls{dice} on more tracts.

An important difference between the two lies in how the fibre orientations, which serve as input to the two methods (as full \glspl{fodf} for tractfinder and as peaks for TractSeg) are computed.
For single shell data, \gls{msmt} \gls{csd} has been used for tractfinder in all datasets and all tracts for consistency, using \gls{wm} and \gls{gm} compartments, to reduce the amount of noise and spurious \gls{wm} signal in non-\gls{wm} areas, most notably the cortex (see also Section \ref{sec:ismrmdiff}).
This is motivated by the need for spatial information with a high specificity for \gls{wm} with which to compare the tract-specific spatial prior in the atlas.
Unfortunately, using only two tissue compartments for \gls{msmt} \gls{csd} in this manner can produce inaccurate reconstructions at tissue boundaries, in particular the subsuming of weak \gls{wm} signal in \gls{csf} partial volume voxels, leading to missing \gls{wm} \glspl{odf} in these areas.
This is the case for tracts like the anterior commissure (CA) and fornices (FX\_left, FX\_right) which are small structures in places directly adjacent to or partially surrounded by \gls{csf}, the reason behind the notably low overlap scores for these structures in Figure \ref{fig:ts_all_tracts}.
Tractfinder based on \gls{ssst} \gls{csd} is much more sensitive to these small structures, at the expense of producing more extensive (less specific) overall tract maps elsewhere.

\begin{figure}[h!]
  \includegraphics{chapter_5/ts_scatter.pdf}
  \caption[Direct comparison between tractfinder and TractSeg, in all tracts]{\Gls{dice} and density correlation scores for tractfinder and TractSeg using the same training and testing streamlines from the HCP105 dataset. Mean over all subjects is shown for each tract.}
  \label{fig:ts_all_tracts}
\end{figure}

\begin{figure}
  \includesvg[width=\textwidth,pretex=\sffamily\small]{chapter_5/tumours.svg}
  \caption[Example tractfinder results in tumour patients]{Tractfinder maps for selected \gls{btc} and clinical subjects. Tumours or resection cavities are marked with asterisks (*), where a double asterisk (**) indicates that tumour deformation modelling was applied.
  \textbf{a.} Right \gls{or} mapped in \gls{btc} subject PAT16 with a right fronto-temporal anaplastic astrocytoma (\gls{who} grade 2--3).
  \textbf{b.} Right \gls{cst} mapped in \gls{btc} subject PAT26 with a right temporal anaplastic astrocytoma (\gls{who} grade 3).
  \textbf{c.} Right \gls{or} mapped in \gls{nhnn} subject 6, intraoperative scan, with a right temporal oligodendroglioma (\gls{who} grade 2).
  \textbf{d.} Right \gls{af} mapped in \gls{btc} subject PAT03 with a right parietal meningioma (\gls{who} grade 1).
  \textbf{e.} Left \gls{af} mapped in \gls{gosh} subject 4, intraoperative scan, with a left temporal pleomorphic xanthoastrocytoma (\gls{who} grade 2).
  \textbf{f.} Left \gls{ifof} mapped in \gls{btc} subject PAT07 with left temporal ependymoma (\gls{who} grade 2)}
  \label{fig:tumours}
\end{figure}

\section{The effect of deformation modelling}
\label{sec:btcd}

The \gls{btc} dataset, with its range of tumour types, high quality \gls{dmri} scans and tumour masks, provides an ideal arena to evaluate the effect of tumour deformation modelling on segmentation accuracy.
Four out of the ten selected \gls{btc} subjects had tumours substantial enough to warrant deformation modelling, which was done using the exponential deformation factor model with adaptive $\lambda$ for all subjects.
Results were compared with manual targeted tractography with additional streamline filtering as described in Section \ref{sec:data_btcd}, which was necessary to ensure a high quality baseline in challenging data with disruptive tumour effects.
Selected tract segmentations in the \gls{btc} dataset are shown in Figure \ref{fig:tumours} (panels a, b, d, and f), alongside additional examples from the \gls{nhnn} and \gls{gosh} clinical data.
Across the whole dataset, including both deforming and non-deforming tumours, tractfinder produced consistently high volumetric similarity scores compared with manual tractography, while an average signed bundle distance close to 0 for all tracts but the \gls{or} indicate consistently high agreement in segmentation margins (Fig. \ref{fig:btcd_box}).

\begin{SCfigure}[][htb!]
  \includegraphics{chapter_5/btcd_defchange.pdf}
  \caption[Effect of deformation modelling in the BTC dataset]{Effect of deformation modelling on segmentation accuracy, compared with manually filtered targeted tractography. Each large datapoint represents the average across tracts for a single subject, and is coloured according to the tumour side. Small datapoints represent individual tracts. In the one subject with a midline tumour, all tracts are considered ipsilateral.}
  \label{fig:btcd_def}
\end{SCfigure}

\begin{figure}[htb!]
  \makebox[\linewidth][r]{%
  \includegraphics{chapter_5/btcd_box.pdf}}
  \caption[Similarity scores against tractography for tractfinder and TractSeg in the BTC dataset]{Similarity scores for tractfinder and TractSeg DKFZ in the \gls{btc} dataset, compared with filtered manual tractography.}
  \label{fig:btcd_box}
\end{figure}


Figure \ref{fig:btcd_def} shows how deformation modelling improves segmentation accuracy in most cases, measured with density correlation, although the sample size is small, and there is considerable variation.
In two subjects, there is no clear overall improvement (average across all tracts) with the addition of deformation modelling.
For subject 11 (highest scores in Figure \ref{fig:btcd_def}), the superior frontal location of the tumour barely affected any of the studied tracts, hence the overall high score and imperceptible improvement with the addition of deformation modelling.
In subject 26, which in Figure \ref{fig:btcd_def} is the only subject showing an average slight decrease in \gls{dice} for ipsilateral tracts with the addition of deformation modelling, the \gls{cst} and \gls{af} actually saw increased scores, while the \gls{ifof} and \gls{or} saw decreases.
In this case, the deformation modelled in the direct vicinity of the temporal lobe tumour was too strong, leading to slightly worse detection of the \gls{ifof} and \gls{or}.
At a greater distance from the tumour, however, the deformation modelled accurately matched the patient anatomy, leading to improved detection of more distant tracts, the \gls{af} and \gls{cst} (Fig. \ref{fig:tumours}, panel b).
