
\section{Validation: methods}

While a ground truth for white matter tract segmentation is not obtainable \textit{in vivo}, it is nevertheless instructive to compare the tractfinder technique with two other widely adopted methods for a quantitative estimation of reliability and accuracy.
We'll quantitatively evaluate tractfinder in three different datasets: Two large healthy datasets (HCP and TractoInferno, see \ref{sec:data}) and one smaller dataset of clinical neurosurgical acquisitions (NHNN and GOSH combined), together covering a range of acquisition protocols and scanner specifications.

In segmentation tasks, it is common to present a single numeric score of similarity with a ground truth by way of establishing accuracy.
However, in the absence of a ground truth for this particular task, we'll instead aim to present as rounded a picture as possible of the differences and characteristic features of each method through a range of different volumetric distance-based similarity metrics.
The purpose of this validation is therefore not to determine which method is best, as indeed cannot be determined without a reliable reference point, but to highlight the ways in which they are similar, and their characteristic tendencies.

\subsection{Benchmark methods}

We'll consider three alternative segmentation approaches and compare each with the proposed method: Probabilistic streamline tractography, representing the current standard, the deep learning direct segmentation technique TractSeg, and a ``naive" atlas registration.
There are numerous alternative techniques, many based on streamline clustering or automatic \gls{roi} registration, including White Matter Analysis (WMA)\autocite{ODonnell2017} RecoBundles \autocite{Garyfallidis2018}, and Tracula.\autocite{Yendiki2011}
We will not be comparing tractfinder with all of these alternatives because such a comparison would hardly provide any additional useful information:
In those methods which rely on a predefined atlas of streamlines or \glspl{roi}, the anatomical assumptions embedded in those predefinitions would influence the similarity metrics more than any methodoligical differences, as indeed they do for the comparisons with TractSeg that follow.
What is more, many of those alternatives have already been systematically compared with TractSeg\autocite{Wasserthal2018}, and so in comparing tractfinder with the latter we can infer relative performance against them.

\paragraph*{Streamline tractography}

Targeted probabilistic streamline tractography (iFOD2 algorithm\autocite{Tournier2010}, from MRtrix3\autocite{Tournier2019} v3.0.3)  was run in each scan using a multi-ROI approach (see \ref{app:rois} for ROI details), with tractography input \glspl{fod} derived from \gls{msmt} \gls{csd} \autocite{Jeurissen2014} using \gls{wm} and \gls{gm} tissue compartments.
In the clinical dataset, ROIs were placed manually for each subject.
For the 184 HCP and TractoInferno subjects, manual ROI placement was infeasible.
Instead the same ROIs were drawn in MNI152 template space aided by the FSL HCP-1065 \gls{dti} template\autocite{FSLATLAS} and transformed to subject space using non-linear registration
(HCP data includes MNI transformation warps, while warps were created for the TractoInferno data using the ANTs registration package v2.4.2 (http://stnava.github.io/ANTs/) \autocite{Tustison2013,Avants2011}).
In theory, the defintions behind the in-house tractography paradigm was the same as for creating the respective atlases.
However, to avoid dependence on resource-intensive tools for cortical parcellation, only white matter \glspl{roi} were used.
The result generally more extensive cortical terminations into gyri and sulci, for example the \gls{af}, not otherwise included in the atlases due to either the use of cortical \glspl{roi} or extensive manual filtering, while the core subcortical portions match the defintions reflected in the atlases. 
This in-house tractography is subsequently abbreviated to ``TG", while the reference TractoInferno bundles are referred to as ``TGR".

\paragraph*{TractSeg}

TractSeg \autocite{Wasserthal2018} is a deep learning tract segmentation model which produces volumetric segmentations for 72 tracts directly from fibre orientation distribution peak directions (TractSeg v2.3-2.6, available at \url{https://github.com/MIC-DKFZ/TractSeg}).
There are two models available: one (``DKFZ") trained on modified streamline reconstructions using TractQuerier \autocite{Wassermann2016} as described in \textcite{Wasserthal2018}, and a second (``XTRACT") trained on streamline density maps output by FSL's XTRACT application. \autocite{Warrington2020}
Here both versions are compared, as they feature significant differences in anatomical tract definition.
Input peaks were derived from the SSST \gls{csd} \glspl{fod}.

\paragraph*{Atlas registration}

As well as the full tractfinder method (atlas alignment and inner product), we'll also consider a ``naive" tract atlas approach, taking only the density component (first SH coefficient) of the linearly registered tract atlases without any comparison with the native \glspl{fod}.
This amounts to a segmentation based on prior spatial expectation only, without taking into account the diffusion data, and is comparable with segmentation approaches that rely entirely on registration, such as common cortical parcellation tools.

\subsection{Comparison metrics}

Each technique is compared against the others, rather than designating any single technique as ``ground truth", with the exception of the TractoInferno dataset, where the published streamlines are regarded as a sort of independent reference.
Several comparison metrics are computed, to capture different kinds of agreement between segmentations.
The Dice-Soerensen similarity coefficient (\gls{dice}) \autocite{Dice1945} is a popular, symmetric measure of segmentation similarity given by

\begin{align}
  DSC &= \frac{2 |A \cap B|}{|A| + |B|}
\end{align}

for two binary voxel sets $A$ and $B$.
Since \gls{dice} is a measure for binary segmentations, it requires the thresholding of continuous-valued maps such as track density maps and the pseudo-probability maps produced by tractfinder, which poses some problems.
Firstly, the conversion from continuous-valued to binary representation introduces a high degree of ambiguity over the appropriate choice of threshold value.
While the simplest and least ambigiuous approach may be to include all voxels with value $>0$ in the segmentation, this makes little sense in practice.
In the case of tractography, a small number of rogue false positive streamlines can massively increase the extent of the binary segmentation, and in the case of TractSeg, very few voxels actually are assigned a probability of 0.
The following thresholds were used throughout, wherever binary segmentations are concerned, are given in Table \ref{tab:thresh}.

\begin{table}[h!]
  \caption{}
  \label{tab:thresh}
  \small
  \begin{tabularx}{\textwidth}{>{\raggedright\arraybackslash}X c >{\raggedright\arraybackslash}X}
    \toprule
    Method    & Threshold value & Reasoning \\
    \midrule
    Tractfinder   & 0.05 & empirically determined \\
    Tractography (streamline density) & 10 & enough to exclude false positives \\
    Reference tractography (TractoInferno only) & 0 & Assume no false positives \\
    Atlas         & 0.1 & values are roughly double those of tractfinder \\
    TractSeg      & 0.5 & consistent with default TractSeg behaviour \\ \bottomrule
  \end{tabularx}
\end{table}

Secondly, the binary nature of a \gls{dice} discounts the additional confidence information present in density and probability maps.
In addition to the binary \gls{dice} measure, therefore, we consider two candidates for a measure of agreement between two continuous valued segmentations.
The first is a generalisation of the \gls{dice} (\gls{gdice}):

\begin{align}
  gDSC &= \frac{2 \sum_i \sqrt{a_ib_i} }{\sum_ia_i + \sum_ib_i}
  =  \frac{2 \sum_i \sqrt{a_ib_i} }{||\mathbf{a}||_1 + ||\mathbf{b}||_1}
\end{align}

The density correlation metric provides an alternative option:
it is simply the Pearson correlation coefficient between the two sets of voxel values.
After considering computing and considering both the \gls{gdice} and density correlation for this analysis, it was determined that one did not provide any further information over the other.
Since the density correlation has been used in other studies for comparing streamline density,\autocite{Radwan2022, Schilling2021a} we will not consider the \gls{gdice} further in this evaluation.

In addition to the volumetric overlap and density metrics, the volumetric bundle adjacency as defined in \textcite{Schilling2021a} is also measured.
However, to avoid confusion with the streamline-based bundle adjacency\autocite{Radwan2022, Garyfallidis2012, Rheault2022} metric previously defined in \textcite{Garyfallidis2012},
and to give more intuitive meaning to the obtained values, we will refer to it as bundle distance $BD$.
It is computed by taking the mean of minimum distances from every non-overlapping voxel, in each segmentation, to the closest voxel in the other segmentation (Fig. \ref{fig:BD}).
Finally, to give a sense of whether the boundary of one segmentation is within or outside that of a second segmentation, we'll also consider the \textit{signed} bundle distance $BD_s$.
This metric is asymmetric, with $BD_s (A,B) = -BD_s(B,A)$.
Thus $BD$ and $BD_s$ are defined as

\begin{align}
  BD(A,B) &= \frac{\sum_{i \in A\setminus B} d_i(B) + \sum_{i \in B\setminus A} d_i(A)}{|A\Delta B|} \label{eq:bd} \\
  BD_s(A,B) &= \frac{\sum_{i \in A\setminus B} - d_i(B) + \sum_{i \in B\setminus A} d_i(A)}{|A\Delta B|} \label{eq:bds}
\end{align}

where $| \cdot |$ denotes set cardinality and $d_i(X)$ is the Euclidean distance transform (defined relative to the foreground of segmentation $X$, i.e. $d_i(X) = 0$ when $i \in X $ and $d_i(X) = |\overrightarrow{ij}|$ when $i \not\in X$ and where $j \in X$ is the voxel in $X$ closest to voxel $i$)  of segmentation $X$ at voxel $i$.

\begin{SCfigure}[50][htbp!]
  \centering
  \includegraphics[width=0.3\textwidth]{segmentations_distance_euc.pdf}
  \caption{Illustration of regions involved in calculating bundle distance metric. Light grey is $A\setminus B$, dark grey area is $B\setminus A$. To compute bundle distance $BD(A,B)$ (Eq. \ref{eq:bd}), the mean minimum absolute distance to the intersection (solid black) is taken across all voxels in the two grey areas $BD(A,B) = (14+4\sqrt{2}+3\sqrt{5})/17 = 1.55$. To compute the signed bundle distance $BD_s(A,B)$ (Eq. \ref{eq:bds}), distance values in A are negated. $BD_s(A,B) = (2-2\sqrt{2}-\sqrt{5})/17 = -0.18$. The Dice score for these two segmentations would be $DSC = 2*4/(13+12) = 0.32$}
  \label{fig:BD}
\end{SCfigure}

\section{Validation: results}
\label{sec:validation}

\subsection{Processing times}

Atlas transformation and inner product computation time per subject for all three tracts and both hemispheres was $18\pm5 s$, plus 1-2 minutes for MSMT-\gls{csd} and 20 seconds for MNI registration.
For TractSeg (DKFZ or XTRACT), mean processing time (for all tracts, 72 for DKFZ and 23 for XTRACT, both hemispheres) was 4:00$\pm$1:00 $min$, plus $15-20 s$ for SSST-\gls{csd}.
For a full processing time breakdown see Table \ref{tab:time}.

For manual streamline tractography, processing time was not explicitly measured, due to the high variability that comes with manual ROI drawing (between 10--25 minutes for all tracts in a single subject, although this varies significantly between operators).
\Gls{hcp} and TractoInferno tractography was run on a high performance computing cluster, taking approximately 10s per tract (single hemisphere), using 36 CPU cores, and additionally up to 2 minutes for non-linear ROI registration (Table \ref{tab:time}).
However, since the time taken depends greatly on several factors, including number of streamlines to select and streamline acceptance rate (often low in pathological brains due to oedema, deformation etc.), a detailed time analysis for manual tractography is not provided here.

%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%
\begin{table*}[htp]
  \caption{Measured processing times mean and standard deviation for TractoInferno dataset. Individual steps shown and total average for the four different pipelines. Note that the tractography pipeline was partially run on a high performance computing cluster, so the reported total time is not representative of a typical setup. Further note that for the present study, tractography ROIs were drawn once for the whole dataset, whereas for clinical datasets manual ROI delineation will have to be repeated for each subject. \dag Desktop Mac with 4 GHz Quad-Core Intel Core i7 \ddag High performance computing cluster, 1 node per subject, 36 Intel(R) Xeon(R) Gold 6240 CPU @ 2.60GHz cores per node.}
  \label{tab:time}
  \small
  \begin{tabularx}{\textwidth}{>{\raggedright}X >{\centering}X ^>{\sffamily}c ^>{\sffamily}c ^>{\sffamily}c ^>{\sffamily}c}
    \toprule
    \rowstyle{\rmfamily}
    Step & Processing time (per subject) & tractfinder & TractSeg & Atlas & tractography \\
    \midrule
    \dag Brain masking & 3 $\pm$ 2 s & x & x & x & x\\
    \dag Affine MNI registration & 20 $\pm$ 4s & x &  & x &  \\
    \dag Response function & 5 $\pm$ 3 s & x & x & x & x\\
    \dag MSMT CSD & 01:50 min $\pm$ 55 s & x &  & x & x\\
    \dag SSST CSD + peaks estimation & 18 $\pm$ 8 s &  & x &  &  \\
    \dag Atlas transformation + inner product (3 tracts) & 18 $\pm$ 5 s & x &  & (x) &  \\
    \dag TractSeg (72 / 23 tracts) & 04:00 $\pm$ 01:00 min &  & x & & \\
    \dag Manual ROI delineation (once for whole dataset) & 20:00 min & & & & x \\
    \ddag Non-linear ROI registration + tractography (3 tracts, 2 hemispheres) & 4:05 $\pm$ 2:08 min & & & & x \\ \addlinespace
    \rowstyle{\bfseries\rmfamily}
    Total &  & 2:36 min & 4:25 min & \textless2:36min & $\gtrsim$26:03 min \\ \bottomrule
  \end{tabularx}
\end{table*}
%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%%


% Fullpage figures
\begin{figure}[htb!]
  \centering
  \begin{subfigure}{0.8\textwidth}
    \includegraphics[width=\textwidth]{chapter_4/tractfinder_cst.png}
    \caption{}
  \end{subfigure}
  \begin{subfigure}{0.8\textwidth}
    \includegraphics[width=\textwidth]{chapter_4/tractfinder_or.png}
    \caption{}
  \end{subfigure}
  \caption{\note{draft} Lightboxes for the projection bundles CST and OR}
  \label{fig:lb.cstor}
\end{figure}
\begin{figure}[htb!]
  \centering
  \begin{subfigure}{\textwidth}
    \includegraphics[width=\textwidth]{chapter_4/tractfinder_af.png}
    \caption{}
  \end{subfigure}
  \begin{subfigure}{\textwidth}
    \includegraphics[width=\textwidth]{chapter_4/tractfinder_ifo.png}
    \caption{}
  \end{subfigure}
  \caption{\note{draft} Lightboxes for association bundles AF and IFO}
  \label{fig:lb.afifo}
\end{figure}

\clearpage
\subsection{Qualitative evaluation}

Qualitative results for a representative subject from the HCP dataset (identified as the only subject within the top 30 smallest deviations from the mean scores for all three of bundle distance, binary \gls{dice} and density correlation) are shown in Figures \ref{fig:lb.cstor}-\ref{fig:lb.afifo}.\note{missing figure: volume.}
The raw tract maps typically have values ranging from 0 to 0.5 (in arbitrary units, derived from the magnitudes of \gls{fod} and atlas distribution functions).
Due to the combined effects of \gls{odf} amplitude and orientation information, a low tract map value can have several causes: a) the \gls{fod} amplitude is low, indicating low evidence for white matter tissue in the voxel in question; b) the atlas amplitude is low, indicating low prior likelihood of the tract being present in that location; c) the peak orientations between the \gls{fod} and atlas are poorly aligned.

Thus combining information from the atlas and data-derived \gls{fod}s improves the tract map estimation over the ``raw" registered atlas in both the spatial and orientational domain. For example, the \gls{tod} atlases have poor definition of gyri and sulci, due to the effect of averaging over many subjects and linear registration. The reduced overall \gls{fod} amplitude in grey matter corrects this non-specificity. And in regions where different white matter structures lie in close proximity, where the atlas can erroneously predict the likely presence of the tract, and \gls{fod} amplitude is high, the lack of orientational agreement discounts the presence of the tract of interest in that location.

\subsection{Quantitative results}

\begin{figure}[h!]
  \centering
  \includegraphics[width=\textwidth]{chapter_4/all_metrics_by_tract_tractoinferno+hcp.png}
  \caption{All methods compared against multi-ROI targeted tracotgraphy for the hcp and tractoinferno datasets combined (except TGR, which is tractoinferno data only). \acrolist{af, cst, or, tf, at, tsx, tsd, tgr}}
  \label{fig:combobox}
\end{figure}

\paragraph*{Performance}

In a realistic clinical context, our target segmentation is represented not by an independently determined and verifiable ground truth, but by the results of whatever approach would normally be taken to produce tract reconstructions for surgical guidance in the absence of any suitable alternative.
That benchmark is targeted multi-ROI streamline tractography, against which we need to evaluate tractfinder.
At the same time, quantitative evaluation using tractography as a reference is problematic as with typical use tractography will produce many false positives that are easily mentally discounted by an experienced viewer, but which will confound quantitative accuracy metrics.


This is one reason why the density correlation metric is particularly useful for comparing methods in this task:
False positive streamlines are more likely to be apparent in areas of low streamline density, and if the proposed segmentation correspondingly predicts a low probability in the same areas, then this will be consistent with a high correlation value.
The density correlation thus helps illustrate the cases where the choice of threshold may have a disproportionate influence on subsequent binary comparisons.
For example, in the HCP dataset and for the corticospinal tract, mean binary \gls{dice} was $0.69$ between tractfinder and tractography and $0.51$ between TractSeg (XTRACT) and tractography (a difference of $0.18$).
For the same two comparisons, the density correlations differed only by $0.04$ ($0.63$ and $0.59$) respectively, indicating strong agreement around areas of high confidence and divergence only in peripheral areas of lower density values.


The signed bundle distance gives an indication of the nature of disagreement between two techniques where other metrics show little difference.
For example, in the HCP dataset and for the arcuate fasciculus, mean bundle distance between the naive atlas and tractography was $5.45 mm$ and mean bundle distance between TractSeg (DKFZ) and tractography was very similar at $5.41 mm$ (Tab. \note{missing table tab:DATAHCP}).
However, the signed bundle distances for those same two comparisons were $+2.57 mm$ and $-2.68 mm$ respectively.
This indicates that, while if only considering the bundle distance metric, both TractSeg and the atlas appear to agree to a similar degree with tractography, TractSeg actually systematically over-segments the \gls{af} (relative to tractography), while the naive atlas segmentation tends towards under-segmentation.

With all this in mind, we find that tractfinder does indeed reliably perform well against tractography across all metrics, with the exception of the \gls{af} when measured on \gls{dice} or distance metrics.
There are a couple possible factors which may account for the worse perfomance for the \gls{af}.
One is the difficulty in consistently reconstructing this tract using only white matter based ROIs (as opposed to cortical ROIs which necessitate more extensive image preprocessing), which are unable to adequately constrain the streamlines as they fan out into numerous cortical regions.
Supporting this theory, tractfinder returned the highest standard deviation values for the arcuate fasciculus out of all \note{three} tracts across all metrics except the signed bundle distance.
It should be noted that, compared to tractography, TractSeg also returns higher standard deviations for the \gls{af}, pointing to an inter-subject variability in tractography segmentations, rather than an high degree of inconsistency in tractfinder performance.
We can also see that the signed bundle distance is significantly higher on average for the \gls{af}, meaning tractfinder typically undersegments the tract relative to tractography, which is to be expected with large volumes streamlines fanning to adjacent cortical termini not included in the curated tract atlas.
Another presumed contributing factor is the unique shape of the arcuate fasciculus, which includes a tight bend around the top of the sylvian fissure.
Alignment of an atlas with this shape is significantly affected by individual anatomy \note{??} which may also partly explain the lower average accuracy for this tract.

Notwithstanding the slightly worse accuracy for the \gls{af}, on balance we can see that tractfinder returns consistently strong agreement with tractography across all metrics.
The fact that comparing the expectations with the native diffusion data, rather than simply registering an atlas, refines and improves the segmentation is also borne out. \note{bit weak}
We also see a high degree of consistency in the levels of agreement between tractfinder and the benchmark methods (\note{figure out how to convey this graphically, alternative to those dice matrices}).
There is little variation in the comparison metrics across subjects, and the overall patterns also remain consistent between the different datasets, both healthy and clinical, which feature a range of aquisitions and ages.

\paragraph*{Tract variability}

Visual assessment reveals that \note{persistent} differences in the shapes of the segmented tracts accounts for a large part of the discrepancy between methods.
Again, this is most apparent in the arcuate fasciculus, where anatomical definitions differ widely (Fig. \note{fig:lb.afr}, \note{fig:lb.afl}).
For example, TractSeg (DKFZ) includes extensive coverage of the frontal and temporal lobe in its \gls{af} segmentations, including parts of the primary motor cortex.
Dice scores between different methods are low across the board for the \gls{af} owing to these anatomical disagreements.
Conversely in the corticospinal tract, which has a relatively well agreed-upon domain, segmentation results have much higher volumetric agreement between methods. \note{need graphic to show this}
Agreement in the optic radiations is somewhere in between, with slightly lower \glspl{dice} compared to the two TractSeg methods, which tend to include more thalamus and a lesser extent of Meyer's loop.
These differences highlight the difficulty in assessing the ``accuracy" of white matter segmentation methods given limited consensus on the precise anatomical definitions of different pathways.

% Figure \ref{fig:combobox} compares each studied method against the reference streamline bundles in the TractoInferno dataset.
% Noticeably, the differences in scores within a single method, between different tracts, are in places greater than the differences between methods within a tract.
% For example, the binary \gls{dice} scores for the \gls{cst} are similar for tractfinder and TractSeg (DKFZ) ($0.48$ and $0.45$ on average respectively), however the binary \gls{dice}s of TractSeg (DKFZ) are markedly different between the \gls{cst} and \gls{or} ($0.45$ and $0.59$ on average respectively). % This is all based on the TGR comparison, which have decided isn't very helpful anyway. Against the TG comparison, in HCP and TI data, this observation goes away

\paragraph*{Reproducibility}

As a final word on repoducibility, we note that the results in Figure \note{fig:METRICSBOXPLOTS} are consistent with the comparisons between TractSeg and RecoBundles published in \textcite{Wasserthal2018}.
There, a mean \gls{dice} of between 0.58 and 0.67 across all tracts was reported.
Our measured \gls{dice}s between TractSeg (DKFZ) and reference tractography (which is based on RecoBundlesX\autocite{Garyfallidis2018}) range between 0.45 and 0.59 across the three tracts studied (Tab. \note{tab:DATATI}).

\paragraph*{TractoInferno}

% \textit{\gls{dice}, \gls{gdice} and density correlation values for tractfinder were on par with TractSeg (XTRACT) in all three tracts, with the exception of density correlation in \gls{af}, while \gls{gdice} and density correlation were higher than TractSeg (DKFZ) in all tracts.
% Binary \gls{dice} scores were highest for TractSeg (DKFZ) in the \gls{cst} and \gls{af}, and equal between tractography, tractfinder and TractSeg (DKFZ)  for the optic radiation.}

While initially we intended to make use of the published TractoInferno streamlines as an unbiased reference for comparison, it became apparent that they were unsuited for this application.
Regardless of tract, metric, or compared methods, the tractofinderno reference streamlines yielded extremely variable results with large numbers of outliers.
Further investigation into these outliers revealed numerous subjects with incomplete or highly asymmetric bundles.
For example, in several cases, optic radiation streamlines only reach the superior portion of the occipital lobe (Fig. \note{fig:DUDSOR}).
In others, the right arcuate fasciculus is significantly smaller than the left (Fig. \note{fig:DUDSAF}).

Given these inconsistencies it was decided to leave the tractoinferno reference streamlines out of any critical analysis on the relative performances of different segmentation approaches.
The tractoinferno dataset features 284 subjects in total (135 were used for the present analysis), and was published with the intention of providing a large and high quality dataset of reference streamlines explicitly for the purpose of training deep learning models for improved tractography and other data-intensitve applications.
The dissapointingly low quality of these bundles is evidence of the difficulty in producing and conducting consistent quality control on streamline tractography bundles with a high degree of anatomical fidelity and inter-subject consistency.
The reliance on such large datasets thus presents a significant challenge to methods such as deep learning and demonstrates the advantage of an approach like tractfinder, as was seen in (\ref{sec:ntrain}).

\paragraph*{Clinical (GOSH \& NHNN)}

The present analysis includs clinical scans with non-deforming lesions, meaning the orientation atlas could be registered to the target image using only affine registration without the need for tumour deformation modelling.
For results in clinical scans featuring deforming lesions, see sections \ref{sec:btcd}, \ref{sec:imri}. %\textcite{Young2022}

Two example clinical subjects, one adult and one paediatric, are displayed in Figure \note{fig:lb.clin}.
In Figure \note{fig:lb.nh}, a sagittal view displays the interaction between the surgical resection cavity and the \gls{cst}.
Here our proposed method maps the \gls{cst} in relatively close proximity to the resection site, where the TractSeg segmentations are far more conservative, potentially missing \gls{cst} locations influenced by oedema or other tumour effects.
In Figure \note{fig:lb.gosh}, the extent of Meyer's loop depicted by tractography is similarly included in the proposed segmentation, but absent from the TractSeg results.

When the results for the clinical dataset were split on hospital / age group (paediatric or adult), no appreciable difference in results was observed (data not shown).
Equally, no systematic difference was observed between intraoperative and preoperative datasets.
The mean score results for all tracts and comparisons are given in Supplementary Table \note{tab:DATACL}.

\subsection{Two methods, same training data}

In order to directly compare tractfinder with the popular deep learning method TractSeg, a new set of tract atlases were created from the TractSeg reference bundles, using the same split into training and testing subjects as used in the deep learning model (published version).
TractSeg was trained on 63 subjects and tested on the remaining 42, and the same was done for tractfinder (where ``training" means computing the atlas from individual bundles), even though tractfinder atlases can be constructed from just 10-15 subjects (see \ref{sec:ntrain}).

\begin{figure}[htb!]
  \includegraphics[width=\textwidth]{chapter_4/tractfinder_trained_on_tractseg.png}
  \caption{Scores for tractfinder (using atlases constructed from the TractSeg training data) and TractSeg validated on the TractSeg reference bundles.}
  \label{fig:ts_atlas}
\end{figure}

In the four main tracts (\gls{af}, \gls{cst}, \gls{ifof}, \gls{or}) Tractfinder scores equally well or better on all metrics with the exception of the Dice coefficient, where in particular the scores for the \gls{ifof} and \gls{or} are lower (Fig. \ref{fig:ts_atlas}).
Since the original TractSeg paper includes 72 tracts (including both left and right instances of non-commisural tracts and multiple subdivisions of tracts such as the corpus callosum or anterior thalamic radiation) and the performance varied substantially across tracts, we'll apply tractfinder to the full dataset for completeness.
This is shown in Figure \ref{fig:ts_all_tracts}, analagous to Figure 6 in \textcite{Wasserthal2018}.
Neither method convincingly outperforms the other, although TractSeg does score higher when measured by \gls{dice} on more tracts.
An important difference between the two lies in how the fibre orientations, which serve as input to the two methods (as full \glspl{fodf} for tractfinder and as peaks for TractSeg) are computed.
For single shell data, we have chosen to use \gls{msmt} \gls{csd} for tractfinder, using \gls{wm} and \gls{gm} compartments, to reduce the amount of noise and spurious white matter signal in non-white matter areas (most notably the cortex).
This is motivated by the need for spatial information with a high specificity for white matter with which to compare the tract-specific spatial prior in the atlas.
Unfortunately, using only two tisse compartments for \gls{msmt} \gls{csd} in this manner can produce inaccurate reconstructions at tissue boundaries, in particular a "cannibilisiation" of weak white matter signal in \gls{csf} partial volume voxels, leading to missing white matter \glspl{odf} in these areas.
This is the case for tracts like the anterior commisure (CA) and fornices (FX\_left, FX\_right) which are small structures in places directly adjacent to \gls{csf}.
Tractfinder based on \gls{ssst} \gls{csd} is much more sensitive to these small structures, at the expense of producing more extensive (less specific) overall tract maps.

\begin{figure}[h!]
  \centering
  \includegraphics[width=0.9\textwidth]{chapter_4/tf_ts_all_tracts.png}
  \caption{\note{draft} Dice similarity and density correlation scores for tractfinder and TractSeg using the same training and testing data. Mean over all subjects is shown for each tract separately.}
  \label{fig:ts_all_tracts}
\end{figure}


\subsection{The effect of deformation modelling}
\label{sec:btcd}

The BTC dataset, with its range of tumour types, high quality \gls{dmri} scans and tumour masks, provides an ideal arena to evaluate the effect of tumour deformation modelling on segmentation accuracy.
Four out of the ten selected BTCD subjects had tumours substantial enough to warrant deformation modelling, which was done using the exponential deformation factor model with adaptive $\lambda$ for all subjects.

\begin{SCfigure}[][htb!]
  \includegraphics{chapter_4/btcd_deformation_corr.png}
  \caption{Effect of deformation modelling on segmentation accuracy, compared to tractfinder without deformation modelling. Each heavy datapoint represents the average across tracts for a single subject, the light datapoints represent individual tracts. There are only three heavy contralateral datapoints because one of the four subjects had a midline tumour (all tracts considered ipsilateral).}
  \label{fig:btcd_def}
\end{SCfigure}

Figure \ref{fig:btcd_def} shows how tractfinder with deformation modelling improves on average segmentation technique.
Notably in these subjects, where large mass effect was present, TractSeg performed significantly worse than tractfinder (although it should be noted that the reference tractography more closely follows the tract definitions used to train tractfinder).
There are two subjects worth considering in detail, where there is no clear improvement with the addition of deformation modelling.
For subject 11 (highest scores in Fig. \ref{fig:btcd_def}), the superior frontal location of the tumour barely affected any of the studied tracts, hence the overall high score and imperceptible improvement with the addition of deformation modelling.
In subject 26, which in Fig. \ref{fig:btcd_def} is the only subject showing an average decrease in DSC with the addition of deformation modelling, the \gls{cst} and \gls{af} actually saw an increase in scores, while the \gls{ifof} and \gls{or} saw a decrease.
In this case, the deformation modelled in the direct vicinity of the temporal lobe tumour was too strong, leading to slightly worse detection of the \gls{ifof} and \gls{or}.
At a greater distance from the tumour, however, the deformation modelled accurately matched the patient anatomy, leading to improved detection of more distant tracts, the \gls{af} and \gls{cst}.
Examples in Figure \ref{fig:btcd_def_pat03} demonstrate how tractfinder including tumour deformation produces tract margins closer to those indicated by tractography than without deformation modelling.

\begin{SCfigure}[50][hb!]
  \includegraphics[width=0.4\textwidth]{chapter_4/sub-PAT03.png}
  \caption{\note{draft} Effect of deformation modelling on tractfinder accuracy demonstrated in BTCD subject sub-PAT03 with large parietal meningioma. Black outline: tractfinder without deformation modelling, orange: tractfinder after deformation modelling, white: tractography (3 streamline isosurface)}
  \label{fig:btcd_def_pat03}
\end{SCfigure}
