\chapter{Practical application}

\note{\normalsize Chapter overview: More qualitative validation in as many sample datasets as possible, including intraoperative data, tumour deformation and debulking cases. Show specific cases where differs from e.g. tractography or TractSeg in specific areas like peritumoural oedema. Also analyse failure cases.}
% \note{Would be nice to also have e.g. epilepsy cases in here?}

\section{Technical considerations}

The technical feasibility of tractfinder for intraoperative application depends not only on the capabilities of the method itself in terms of speed and reliability, but also on the achievable image quality.
Intraoperative scanning must occur under significant time pressure, and the concessions made to achieve this will have profound consequences for the image quality and subsequent image processing.
In general, two strategies exist for reducing diffusion MRI scan time:
The first is to reduce the \note{data richness} of the acquisition.
This could mean lower spatial resolution (larger voxels), lower angular resolution (fewer diffusion-weighted directions), sorter diffusion weightings (lower $b$-values) or fewer unique $b$-values ("shells").
The second is to use accelerated imaging techniques.

\subsection{Data requirements}\label{sec:ismrmdiff}

It is important to assess the applicability of image processing techniques developed with research quality data in acquisitions more typical of a clinical setting.
It is common for advanced \gls{dmri} processing techniques to set constraints on the input data, such as recommending or requiring a minimum number of diffusion weighted volumes (angular resolution), $b$-values or spatial resolution.

If you can demonstrate that an image processing pipeline produces excellent results in a high quality research dataset, which can be interpreted with confidence, then the question follows:
Were one to acquire a lower quality dataset of the same subject, and perform the same data processing, how comparable would the resulting segmentation be to that of the high quality scan?

It is fairly straightforward to explore this question, given a high quality sample dataset.
Such data can be downsampled, in both the spatial and angular domains, to produce a simulated lower quality scan of the same subject.
Here we set out to determine the minimum data requirements to obtain successful segmentation, comparing different numbers of direction samples, $b$-values and post-processing strategies, as well as the affects of decreasing data quality on segmentation stability.
The effects on the perfomance of TractSeg and tractography are compared as well.

\paragraph*{Data and methods}

49 Preprocessed dMRI datasets from the HCP 1200 data release were spatially resampled to 2.5mm isotropic voxel size (from the original of 1mm isotropic), a resolution far more common in both clinical and research settings.
Then, for each subject, the following 5 subsampled diffusion schemes were extracted from the full dataset (see Tab. \ref{tab:subschemes}):
60 directions each at $b=1000s/mm^2$ and $b=2000s/mm^2$ (120 directions total, ``DWI-1”), 30 directions each at $b=1000s/mm^2$ and $b=2000s/mm^2$ (60 directions total, ``DWI-2”), 60 directions at $b=1000s/mm^2$ (``DWI-3”), 30 directions at $b=1000s/mm^2$ (``DWI-4”) and 12 directions at $b=1000s/mm^2$ (``DWI-5”).

\begin{table}
  \centering
  \begin{tabular}{c c c} \toprule
    Identifier & $b = 1000$ & $b=2000$ \\
    \midrule
    DWI-1 & 60 & 60 \\
    DWI-2 & 30 & 30 \\
    DWI-3 & 60 &    \\
    DWI-4 & 30 &    \\
    DWI-5 & 12 &    \\ \bottomrule
  \end{tabular}
  \caption{Subsampled diffusion schemes}
  \label{tab:subschemes}
\end{table}

For each dataset four different tract segmentations are produced using three different approaches: Tractfinder, targeted ROI-based, probabilistic streamline tractography (iFOD2), and TractSeg.
TractSeg, a deep learning-based direct segmentation technique, ships with two different pre-trained models:
one trained on tract segmentations obtained as described in Wasserthal et al. (2018) (``TractSeg - DKFZ”), and another trained on XTRACT7 outputs (``TractSeg - XTRACT”).
Two different TractSeg results were obtained by running both models.
Segmentations were compared for the three tracts most commonly reconstructed in neurosurgical applications: the corticospinal tract, arcuate fasciculus and optic radiations.

All tract segmentation methods are predicated on fibre orientation distributions (FOD) modelled from diffusion data, and although tractography and TractSeg could both use other FOD modelling outputs such as BedpostX, the current analysis is kept to constrained spherical deconvolution (CSD) only.
For the two-shelled datasets, multi-shell multi-tissue (MSMT) CSD10 can be run to separate the signal contributions from white matter (WM), grey matter (GM) and cerebrospinal fluid (CSF) and thus obtain an optimal WM FOD image free of noisy extraneous signal in non-WM regions.
For the single-shelled datasets, full, direct MSMT with all three tissue types is not possible.
Instead, the following approaches are compared: 1) Modelling two tissue types with MSMT.
MSMT CSD is performed twice, once modelling WM and GM compartments, and once modelling WM and CSF compartments; 2) Standard single shell CSD ``original flavour".

To investigate the effects of different data quality and modelling on a given method, the Dice similarity coefficient (DSC) is computed between each segmentation in datasets DWI 2-5 and the corresponding segmentation of the same method in DWI 1 using MSMT (considered the baseline segmentation).
This ``self-similarity" approach is intended to answer the question put forward above: how close to the results produced from an ``ideal" dataset be achieved from a lower quality dataset.
This comparison was made for each combination of data quality and CSD approach.

\paragraph*{Findings}

\begin{figure}
  \centering
  \includegraphics{chapter_4/self_dice.png}
  \caption{Self dice scores \note{caption}}
  \label{fig:self_dice}
\end{figure}

DSC results are plotted in Figure \ref{fig:self_dice}.
Each datapoint corresponds to the segmentation produced from a particular dataset, method and pipeline \textit{compared against} the result obtained from the highest quality dataset.
The consistency in segmentation results differed significantly with both data quality and CSD approach.
The high sensitivity to CSD approach in the tractography and Tractfinder results, particularly the large differences between MSMT WM+CSF / SSST and MSMT WM+GM, can be attributed to the amount of spurious grey matter signal included in the WM FOD reconstructions.
In the former two approaches, the GM compartment is not as aggressively suppressed from the WM reconstruction, resulting in WM ``signal” in grey matter areas (which is then incorporated into the segmentation: in tractography via the further propagation of streamlines into GM, and in Tractfinder directly due to higher WM signal amplitude in GM).

TractSeg, while not immune, appears less sensitive to CSD reconstruction technique.
When considering only the best results (MSMT in DWI-2 and, in the single-shelled datasets, MSMT WM+GM for tractography and Tractfinder and SSST for TractSeg; Fig. 2), tractography displays the greatest instability with decreasing data quality, with the similarity score between DWI-5 MSMT WM+GM and DWI-1 MSMT falling as low as 0.78 (subject and cerebral hemisphere mean) for the arcuate fasciculus.
TractSeg is trained on SSST CSD in single-shelled data as well as multi-shelled data, explaining why it does best with either SSST or MSMT WM+CSF in our single-shell results.

The comparatively high sensitivity of probabilistic tractography to acquisition and processing pipelines is consistent with the well-established reproducibility and noise sensitivity problems associated with tractography.
Meanwhile, voxel-wise segmentation methods are not susceptible to error propagation along the tract and are more robust to lower angular resolution.
Understanding the behaviour of different tract segmentation techniques when applied to varying qualities of dMRI acquisition and post-processing approaches is important if segmentation methods developed in research settings are to be consistently and reproducibly applied to clinical quality acquisitions.
It is useful to know how comparable segmentation results in a single-shelled, 30 direction dataset are to those one might have obtained with a HARDI dataset and state-of-the-art post-processing.
This is particularly relevant for longitudinal studies, or when comparing different acquisitions of the same subject in a clinical context (e.g., for monitoring disease progressions, post-operative changes etc.).

\subsection{Fast imaging and artefacts}

Because high angular resolution \gls{dmri} acquisitions involve acquiring many volumes of data, they would have prohibitively long scan times without the use of \gls{epi}.
A common complaint about \gls{epi} concerns the geometric image distortions that commonly arise at the boundaries between areas of different magnetic susceptibility, typically at tissue/air interfaces.
For intraoperative scanning, this poses a particular problem in which the very region of interest, the operative field and surgical cavity, can suffer from the strongest distortions, affecting nearby structures (such as white matter tracts) that are of neuronavigational importance.\autocite{Yang2022}
In most applications, these artifacts are tolerated as they can be fairly robustly corrected for offline at the image proprocessing stage.
However, not only can the distortions around resection cavities be especially severe due to the large exposed area of brain (Fig. \ref{fig:epi}), neither can they be easily corrected for intraoperatively, as the current tools take on the order of tens of minutes to hours to run.

\begin{figure}[h!]
  \includegraphics[width=\textwidth]{chapter_4/epidist.png}
  \caption{\note{draft}Examples of strong susceptibility distortions on intraoperative \gls{epi} acquisitions}
  \label{fig:epi}
\end{figure}

As an alternative to \gls{ssepi}, multi-shot (MS) sequences have been proposed.
These include interleaved and readout-segmented (RS) sequences which, in general, only traverse a portion of k-space per echo train, increasing the bandwidth along the phase-encoding direction (and thus reducing field inhomogeneity induced phase accumulation) but increasing scan time.\autocite{Wang2018}
RESOLVE (readout segmentation of long variable echo-trains), a Siemens product, is one example of a commonly used \gls{rsepi} sequence.

While RESOLVE can be combined with generalised autocalibrating partially parallel acquision (GRAPPA) and simultaneous multislice (SMS) acceleration tecniques, they nevertheless result in significantly longer scan times, which, in clinical applications, must be weighed against any gains in image quality and distortion reduction.
For example, in \textcite{Wang2018} the authors compared readout-segemented and interleaved EPI sequences with \textit{in vivo} scan times of around ten minutes, while only acquiring four slices of 4mm thickness!
In \textcite{Elliott2020}, \gls{ssepi} was compared with a RESOLVE DTI sequence with 15 segments, 6 DW directions, and a scan time of 10:34.
For comparison, the clinical DTI sequence currently used intraoperatively at GOSH is a 30xb1000 acquisition lasting just 4:57 with 2.3mm isotropic voxels.

We set out to explore the feasibility of setting up a \gls{rsepi} DTI sequence for intraoperative use at GOSH.
An (approximately) isotropic voxel size is generally considered optimal for DTI modelling and tractography \autocite{Vos2011, Neher2013}, although tractography with high in plane resolution and thick slices is certainly possible.
Additionally, sufficient diffusion weighted directions for crossing fibre modelling (e.g CSD) would be ideal.
In the end, we tested three different DTI sequences as well as several different 3-scan trace RESOLVE sequences (not discussed here), all acquired on GOSH’s intraoperative Siemens VIDA (3T) system from a healthy adult volunteer.
The acquisition parameters of the three test sequences, along with the standard GOSH \gls{dmri} sequences for comparison, are shown in Table \ref{tab:rsepi}.

% [1] Yang, J. Y.-M. *et al.* Assessment of intraoperative diffusion EPI distortion and its impact on estimation of supratentorial white matter tract positions in pediatric epilepsy surgery. *NeuroImage: Clinical* **35**, 103097 (2022).  https://www.sciencedirect.com/science/article/pii/S2213158222001620
% [2] Wang, Y. *et al.* A comparison of readout segmented EPI and interleaved EPI in high-resolution diffusion weighted imaging. *Magnetic Resonance Imaging* **47**, 39–47 (2018). DOI: 10.1016/j.mri.2017.11.011
% [3] Elliott, C. A. *et al.* Intraoperative acquisition of DTI in cranial neurosurgery: readout-segmented DTI versus standard single-shot DTI. *Journal of Neurosurgery* **133**, 1210–1219 (2020). http://dx.doi.org/10.3171/2019.5.JNS19890
% [4] https://archive.ismrm.org/2011/1945.html
% [5] https://www.researchgate.net/publication/236022704_Analysis_of_tractography_biases_introduced_by_anisotropic_voxels

\begin{table}
  \caption{RS-EPI test scan parameters}
  \label{tab:rsepi}
  \small
  \begin{tabularx}{\textwidth}{l X X X X X} \toprule
    & GOSH VIDA “clinical” (RESOLVE) & GOSH VIDA Clinical DTI & Test scan 1: 7seg 6xb800 & Test scan 2: 3seg 12xb1000 & Test scan 3: 3seg 20xb1000 \\
  \midrule
   $n$ directions & 3 & 30 & 6 & 12 & 20 \\
   b values & 0, 800 & 0, 1000 & 0, 800 & 0, 1000 & 0, 1000 \\
   scan time (min) & 4:53 & 4:57 & 4:57 & 7:30 & ? \\
   voxel size (mm) & 1.198 x 1.198 x 4 & 2.3 x 2.3 x 2.3 & 2.3 x 2.3 x 2.1 & 2.5 x 2.5 x 2.5 & 2.3 x 2.3 x 2.3 \\
   size (voxels) & 192 x 192 x 35  & 96 x 96 x 62 & 96 x 96 x 47 & 88 x 88 x 58 & 96 x 96 x 58 \\
   FOV (mm)  & 230 x 230  & 220 x 220 & 220 x 220 & 220 x 220 & 220 x 220 \\
   TR (ms) &  & 6600 & 6570 & 8960 & 3850 \\
   segments & 7 & 1 & 7 & 3 & 3 \\
   GRAPPA & 2 & 2 & 2 & 2 & - \\
   SMS &  &  &  &  & 2 \\ \bottomrule
  \end{tabularx}
\end{table}

For each scan, minimal preprocessing was done in MRtrix3:\autocite{Tournier2019} MPPCA denoising and bias field correction, followed by diffusion tensor modelling and colour (DEC) FA mapping and single-shell single-tissue CSD.
For CSD, $l_{max}$ was set to 8 except for the six direction scan where $l_{max}=6$ was used.
No distortion correction was applied.
Finally, a simple \gls{cst} probabilistic tractography protocol was applied, using the internal capsule as a seed region and an inclusion ROI at brain stem level, along with exclusion ROIs for common false positives.

\begin{figure}[h!]
  \centering
  \begin{subfigure}[b]{0.65\textwidth}
    \centering
    \includegraphics[width=\textwidth]{chapter_4/rsepi/ortho0.png}
  \end{subfigure}%
  \begin{subfigure}[b]{0.3\textwidth}
    \centering
    \includegraphics[height=0.7\textwidth]{chapter_4/rsepi/cofa0.png}
  \end{subfigure}
  %
  \begin{subfigure}[b]{0.65\textwidth}
    \centering
    \includegraphics[width=\textwidth]{chapter_4/rsepi/ortho1.png}
  \end{subfigure}%
  \begin{subfigure}[b]{0.3\textwidth}
    \centering
    \includegraphics[height=0.7\textwidth]{chapter_4/rsepi/cofa1.png}
  \end{subfigure}
  %
  \begin{subfigure}[b]{0.65\textwidth}
    \centering
    \includegraphics[width=\textwidth]{chapter_4/rsepi/ortho2.png}
  \end{subfigure}%
  \begin{subfigure}[b]{0.3\textwidth}
    \centering
    \includegraphics[height=0.7\textwidth]{chapter_4/rsepi/cofa2.png}
  \end{subfigure}
  %
  \begin{subfigure}[b]{0.65\textwidth}
    \centering
    \includegraphics[width=\textwidth]{chapter_4/rsepi/ortho3.png}
  \end{subfigure}%
  \begin{subfigure}[b]{0.3\textwidth}
    \centering
    \includegraphics[height=0.7\textwidth]{chapter_4/rsepi/cofa3.png}
  \end{subfigure}
  \caption{From top: baseline (30xb1000 SSEPI DTI), 7seg 6xb800, 3seg 12xb1000, 3seg 20xb1000}
  \label{fig:rsepi}
\end{figure}

Based on visual assessment alone, the degree of distortion reduction is difficult to evaluate for all compared sequences (Fig. \ref{fig:rsepi}).
It’s unclear whether, in the case of intraoperative scans with high levels of distortion at the resection site, the amount of distortion improvement would be comparatively greater than is apparent in a healthy scan with minimal distortion to begin with.
The third teset scan used simultaneous multislice (SMS) acceleration which appears to have significantly degraded and even corrupted the scan, \note{even though iemens advertises RESOLVE with SMS}
\footnote[2]{\url{https://www.siemens-healthineers.com/en-uk/magnetic-resonance-imaging/options-and-upgrades/clinical-applications/syngo-resolve} retrieved 06-Oct-2023}


\begin{figure}[h!]
  \begin{subfigure}{0.22\textwidth}
    \includegraphics[width=\textwidth]{chapter_4/rsepi/fod0.png}
  \end{subfigure}%
  \begin{subfigure}{0.22\textwidth}
    \includegraphics[width=\textwidth]{chapter_4/rsepi/cst0.png}
  \end{subfigure}
  %
  \begin{subfigure}{0.22\textwidth}
    \includegraphics[width=\textwidth]{chapter_4/rsepi/fod1.png}
  \end{subfigure}%
  \begin{subfigure}{0.22\textwidth}
    \includegraphics[width=\textwidth]{chapter_4/rsepi/cst1.png}
  \end{subfigure}
  %
  \begin{subfigure}{0.22\textwidth}
    \includegraphics[width=\textwidth]{chapter_4/rsepi/fod2.png}
  \end{subfigure}%
  \begin{subfigure}{0.22\textwidth}
    \includegraphics[width=\textwidth]{chapter_4/rsepi/cst2.png}
  \end{subfigure}
  %
  \begin{subfigure}{0.22\textwidth}
    \includegraphics[width=\textwidth]{chapter_4/rsepi/fod3.png}
  \end{subfigure}%
  \begin{subfigure}{0.22\textwidth}
    \includegraphics[width=\textwidth]{chapter_4/rsepi/cst3.png}
  \end{subfigure}
  \caption{From left to right, top to bottom: baseline (30xb1000 SSEPI DTI), 7seg 6xb800, 3seg 12xb1000, 3seg 20xb1000}
  \label{fig:rsepi-fod}
\end{figure}

Figure \ref{fig:rsepi-fod} demonstrates the \glspl{fod} and tractography reconstructions obtained from each sequence.
The 6 direction scan results in poorly resolved \glspl{fod} and correspondingly noisy streamlines and the third test scan which was degraded due to the use of SMS produced entirely unusable \glspl{fod}.
Most promising are the results obtained from the 12 direction scan, despite the low angular resolution, although there is certainly still a lot of noise.
The findings presented in \ref{sec:ismrmdiff} indicate that a 12 direction scan, while far from ideal, could still be used to obtained reliable tract segmentations.
It is simply a question of priorities: is the achievable reduction in susceptibility distortion worth the implications of lower angular resolution?
This is a question that cannot be answered from such exploratory data, and indeed the answer is likely to be case-specific, given that the amount of distortion varies significantly from scan to scan depending on the specific patient and surgical setup.
While further exploration of distortion reduction was not a priority of this project, it remains an interesting avenue for future research, and these preliminary findings provide an indication that a readout-segmented \gls{epi} for intraoperative imaging remains an open possibility.
