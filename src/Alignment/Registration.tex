\chapter{Aligning atlas and data}
\label{chap:reg}

Each tract atlas is constructed in a standard template space, and before being used to estimate the location of a tract in a new patient it must first be aligned with that patient's anatomy.
In order to achieve this, some sort of registration strategy is needed, with the most appropriate registration approach depending on the type of application.
In healthy subjects, it is sufficient to use affine registration to transform the atlas from template into subject space, before the inner product (or whichever comparison is used) is calculated.
However, in some patient data, more advanced processing may be necessary to ensure satisfactory alignment with target anatomy.
The following sections will describe the registration methods used in tractfinder for different scenarios, and including the use of tumour deformation modelling to account for space-occupying lesions.

\section{Registration from standard space}

There are two categories of image registration.
In global registration, a single transform applies to the entire image, preserving its topology.
Different degrees of freedom define some commonly used terms: rigid body registration comprises just translation and rotation, while affine registration further includes scaling and shearing (up to 12 degrees of freedom on $\mathbb{R}^3$).
Following purely algebraic definition, a linear transform does not include translation, however in practice (at least in the medical imaging sphere) ``linear" and ``affine" are used interchangeably.
Non-linear, deformable, or diffeomorphic registrations compute local deformations on a voxel-by-voxel basis, and therefore have orders of magnitude more degrees of freedom.
They are useful for fine-grained alignment of local structures, but many algorithms are unstable and prone to converging on local minima, making them difficult to successfully integrate into automated pipelines.

As we saw in Chapter \ref{chap:atlas}, a certain degree of inter-subject variability, including both tract-specific and global anatomical differences, is a feature of the atlas due to the use of affine registration to combine the training data in template space.
We mirror this relationship by allowing the atlas to be registered to a new target dataset using affine registration alone, with the subsequent comparison with native \gls{dmri} data acting to correct slight misalignments due to anatomical variability.
Computing a non-linear registration between atlas and subject at the point of application is undesirable principally due the lack of robust, stable and generalisable algorithms that are open source.
Maintaining practicality is a key requisite of tractfinder, and trials have found various non-linear registration tools to either be too unstable (requiring manual adjustment of parameters in difficult cases such as some clinical scans) or having too long a computation time.

As we shall see in the range of evaluations presented in Part \ref{part3}, the use of affine registration does not result in significant segmentation inaccuracies or errors, thus there is no credible incentive to favour the use of non-linear registration at the cost of increased processing time and potential instabilities.
Indeed, \textcite{Visser2020} showed that subject-to-standard registration accuracy of the tumoural region in low and high grade gliomas is not significantly improved using non-linear registration across a range of different packages, concluding there is little to justify the additional time cost and lack of robust automation.
Nevertheless, the trade-offs associated with relying on affine registration must be acknowledged.
Particularly in brains with modest deformations or other lesions, the accuracy of anatomical alignment can be impacted, and there follows the risk of suboptimal spatial and / or orientational alignment, resulting in missed areas (false negative) or erroneously included regions (false positives).

The risk of misalignment is especially high for small structures, such as the fornix or anterior commissure, both narrow bundles which are reliably difficult to segment.
For these cases, the construction of the atlas with spatial inter-subject smoothing is advantageous, as even with slight misalignment there is still a good chance that enough of the atlas will overlap with the structure in the target image to achieve detection.
However, this same feature may also lead to false positives in some cases, such as when two distinct tracts run in parallel, oriented the same way in relative spatial proximity.
An example of this scenario can be seen at the temporoparietal fibre intersection area, where at least seven different identified bundles converge.\autocite{Martino2013b}
Here the vertical portion of the arcuate fasciculus lies lateral to the sagittal stratum containing antero-posteriorly oriented association fibres (including the \gls{or}), which in turn lies lateral to the tapetum of the corpus callosum.
The similar orientations of the the \gls{af} and tapetum in this region, together with their close proximity, could lead to fibres of one wrongly being attributed to the other if the atlas is too broad (Fig. \ref{fig:tpfia}).

\begin{SCfigure}[][h!]
  \captionsetup{format=plain}
  \includegraphics[width=0.6\textwidth]{chapter_3/tpfia.png}
  \caption{Example of potential for atlas misalignment. The \gls{af} (*) and tapetum (**) are proximal and parallel at the temporoparietal fibre intersection area. Linearly registered right \gls{af} atlas \glspl{tod} may overlap with tapetum (arrow).}
  \label{fig:tpfia}
\end{SCfigure}

In conclusion, affine registration between template and subject space is preferred in most applications, including for healthy subjects and clinical subjects without large space-occupying lesions.
The next sections will address the scenarios where patient anatomical topology differs significantly from atlas space: in the presence of deforming tumours, or intraoperative brain shift.

\section{Intra-patient registration and brain shift}

Given the target application of intraoperative \gls{wm} imaging, it would be entirely remiss to not discuss the additional registration issues \note{hailed brought on} by brain shift.
Predictably, the sheer variability and unpredictability in direction, magnitude and extent of brain shift means that a universally elegant and robust solution cannot be found.
Instead, we will discuss some common intraoperative scenarios and how tractfinder would be applied to them.

One major source of brain shift is tumour debulking.
As tumour is removed through the craniotomy, the surrounding tissue collapses and the associated mass effect is reduced.
For this situation, tumour deformation can be utilised using a preoperative segmentation of the tumour and adjustment of the tumour scale parameter $s$, which if set to a value below one will virtually decrease the tumour radius, mimicking the debulking effect.
A case study demonstrating this is presented in Section \ref{sec:case}.
The necessary steps in such a scenario would be affine registration between pre- and intraoperative subject space, re-computation of tumour deformation field using preoperative tumour segmentation and $s<1$, affine atlas transformation to intraoperative space, atlas deformation, and finally tract mapping with intraoperative \gls{fod} image.
The additional steps of pre- to intraoperative registration and tumour deformation would add less than five minutes to the total processing time.

Of course, tumour debulking does not always result in intraoperative brain shift that looks like a simple reduction in mass effect.
Often, a certain degree of tissue inertia means that surrounding structures don't instantly relax back into a more ``normal" position, and the effects of gravity, \gls{csf} drainage, herniation, or intracranial pressure changes will have a far more drastic influence on overall brain shift than the removal of tumour tissue.
In these cases, tumour deformation modelling cannot be leveraged to account for brain shift, and different registration strategies will be required.
Affine registration is able to model anisotropic scaling, which may be sufficient for brain shift principally characterised by sagging or compression due to gravity.

Finally, there are those cases in which topological differences between pre- and intraoperative scans are so great that neither affine registration nor adjust tumour deformation can sufficiently align the data.
In these subjects, advanced deformable registration is necessary.
The task of intraoperative registration to account for brain shift is a well studied one, although in most cases the approach is to deform preoperative data (such as streamlines) to continually provide accurate neuronavigation after brain shift.\autocite{Clatz2005,Archip2007,Wittek2007,Archip2008}
This requires highly accurate registration, as there is no intraoperative \gls{dmri} acquisition to inform tract identification.
For tractfinder, it would be preferable to impose stricter regularisation to increase registration stability and minimise the creation of unphysical distortions (e.g. surrounding the site of resection), since any consequent minor misalignments can be handled by the atlas smoothness and comparison with local diffusion data.
In individual case studies, non-linear registration has successfully been leveraged in this way (Fig. \note{example figure}).
However, this is still only possible in an experimental setting and involves significant trial-and-error in determining the appropriate registration input parameters, and it remains the subject of future work to achieve robust generalisation and automation.
