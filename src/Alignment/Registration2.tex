\section{Intra-patient registration and brain shift}

Given the target application of intraoperative \gls{wm} imaging, it would be entirely remiss to not discuss the additional registration issues brought about by brain shift.
Predictably, the sheer variability in direction, magnitude and extent of brain shift means that a universally elegant and robust solution cannot be found.
Instead, we will discuss some common intraoperative scenarios and how tractfinder would be applied to them.

One major source of brain shift is tumour debulking.
As tumour is removed through the craniotomy, the surrounding tissue may collapse and the associated mass effect be correspondingly reduced.
For this situation, tumour deformation can be utilised using a preoperative segmentation of the tumour and adjustment of the tumour scale parameter $s$, which if set to a value below one will virtually decrease the tumour radius, mimicking the debulking effect.
A case study demonstrating this is presented in Section \ref{sec:case}.
The necessary steps in such a scenario would be affine registration between pre- and intraoperative subject space, re-computation of tumour deformation field using preoperative tumour segmentation and $s<1$, affine atlas transformation to intraoperative space, atlas deformation, and finally tract mapping with intraoperative \gls{fod} image.
The additional steps of pre- to intraoperative registration and tumour deformation would add less than five minutes to the total processing time.

Of course, tumour debulking does not always result in intraoperative brain shift that looks like a simple reduction in mass effect.
Often, a certain degree of tissue inertia means that surrounding structures don't instantly relax back into a more ``normal'' position, and the effects of gravity, \gls{csf} drainage, herniation, or intracranial pressure changes will have a far more drastic influence on overall brain shift than the removal of tumour tissue.
In these cases, tumour deformation modelling cannot be leveraged to account for brain shift, and different registration strategies will be required.
Affine registration with anisotropic scaling may be sufficient for brain shift principally characterised by sagging or compression due to gravity.

Finally, there are those cases in which topological differences between pre- and intraoperative scans are so great that neither affine registration nor adjusted tumour deformation can sufficiently align the data.
In these subjects, advanced deformable registration is necessary.
The task of intraoperative registration to account for brain shift is a well studied one, although in most cases the approach is to deform preoperative data (such as streamlines) to continually provide accurate neuronavigation after brain shift.\autocite{Clatz2005,Archip2007,Wittek2007,Archip2008}
This requires highly accurate registration, as there is no intraoperative \gls{dmri} acquisition to inform tract identification.
For tractfinder, it would be preferable to impose stricter regularisation to increase registration stability and minimise the creation of unphysical distortions (e.g. surrounding the site of resection), since any consequent minor misalignments can be handled by the atlas smoothness and comparison with local diffusion data.
In individual case studies, non-linear registration has successfully been leveraged in this way (Fig. \ref{fig:nrrex}).
However, this is still only possible in an experimental setting and involves significant trial-and-error in determining the appropriate registration input parameters, and it remains the subject of future work to achieve robust generalisation and automation.

\begin{figure}[hb!]
  \centering
  \includegraphics[width=\textwidth]{chapter_3/nrr_gosh_2.png}
  \caption{Example of non-linear registration applied to a \gls{gosh} \gls{imri} patient. Left: Intraoperative scan with colour \gls{fa} map overlaid to enhance \gls{wm} contrast, registered to preoperative scan (rigid registration). Outline of white matter segmentation of preoperative scan is overlaid, demonstrating substantial brain shift away from the craniotomy (*). Arrow highlights shifting of the ipsilateral external capsule. Dotted line indicates position of coronal plane in right image. Right: Tractfinder map of bilateral \gls{cst} after non-linear registration between pre- and intraoperative scans, using the Fast Free-Form Deformation algorithm\autocite{Modat2010} from the NiftyReg package (\url{http://cmictig.cs.ucl.ac.uk/wiki/index.php/NiftyReg}).}
  \label{fig:nrrex}
\end{figure}

\section{Summary}

All atlas-based image segmentation or analysis techniques have to contend with the problem of aligning said atlas with the target image, and tractfinder is no exception.
In this chapter we have considered the available solutions to this problem, their respective advantages and drawbacks, and applicability to various practical scenarios.

By designing a fuzzy atlas which allows for inter-subject variability to provide an initial estimate for a tract's expected features in the target image, and relying on additional subject-specific information to refine that estimate, we can avoid the need for voxel-perfect atlas alignment, as long as the registered atlas fully covers the domain of the target tract.
In healthy and structurally normal data, affine registration with 12 degrees of freedom is fully sufficient to achieve this coverage.
We saw in section \ref{sec:reg1} that non-linear registration is unlikely to provide any significant improvement in performance, and only decrease speed and practicality.

Where space occupying lesions are concerned, however, simple affine registration can leave the registered tract atlas entirely misaligned with the corresponding subject anatomy.
In such cases, more advanced atlas deformation is necessary to account for the effects of tumours, while still keeping the compute complexity to an acceptable minimum for clinical implementation.
A simple radial deformation algorithm is proposed to specifically account for mass effect after initial affine registration, which successfully models gross tract displacements.

Finally, we saw how the stringent assumptions of the tumour expansion model do not adequately support the modelling of infiltrating tumours, and how the complexities of brain shift may call for more involved registration tactics, including non-linear algorithms and others developed specifically for intraoperative registration.
In the next chapters we will put the methodological components together and assess the proposed techniques' performance in a series of quantitative evaluations and practical applications.
