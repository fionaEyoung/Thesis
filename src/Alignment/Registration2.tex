\section{Intra-patient registration and brain shift}

Given the target application of intraoperative \gls{wm} imaging, it would be entirely remiss to not discuss the additional registration issues brought about by brain shift.
Predictably, the sheer variability in direction, magnitude and extent of brain shift means that a universally elegant and robust solution cannot be found.
Instead, we will discuss some common intraoperative scenarios and how tractfinder would be applied to them.

One major source of brain shift is tumour debulking.
As tumour is removed through the craniotomy, the surrounding tissue may collapse and the associated mass effect be correspondingly reduced.
For this situation, tumour deformation can be utilised using a preoperative segmentation of the tumour and adjustment of the tumour scale parameter $s$, which if set to a value below one will virtually decrease the tumour radius, mimicking the debulking effect.
A case study demonstrating this is presented in Section \ref{sec:case}.
The necessary steps in such a scenario would be affine registration between pre- and intraoperative subject space, re-computation of tumour deformation field using preoperative tumour segmentation and $s<1$, affine atlas transformation to intraoperative space, atlas deformation, and finally tract mapping with intraoperative \gls{fod} image.
The additional steps of pre- to intraoperative registration and tumour deformation would add less than five minutes to the total processing time.

Of course, tumour debulking does not always result in intraoperative brain shift that looks like a simple reduction in mass effect.
Often, a certain degree of tissue inertia means that surrounding structures don't instantly relax back into a more ``normal" position, and the effects of gravity, \gls{csf} drainage, herniation, or intracranial pressure changes will have a far more drastic influence on overall brain shift than the removal of tumour tissue.
In these cases, tumour deformation modelling cannot be leveraged to account for brain shift, and different registration strategies will be required.
Affine registration with anisotropic scaling may be sufficient for brain shift principally characterised by sagging or compression due to gravity.

Finally, there are those cases in which topological differences between pre- and intraoperative scans are so great that neither affine registration nor adjusted tumour deformation can sufficiently align the data.
In these subjects, advanced deformable registration is necessary.
The task of intraoperative registration to account for brain shift is a well studied one, although in most cases the approach is to deform preoperative data (such as streamlines) to continually provide accurate neuronavigation after brain shift.\autocite{Clatz2005,Archip2007,Wittek2007,Archip2008}
This requires highly accurate registration, as there is no intraoperative \gls{dmri} acquisition to inform tract identification.
For tractfinder, it would be preferable to impose stricter regularisation to increase registration stability and minimise the creation of unphysical distortions (e.g. surrounding the site of resection), since any consequent minor misalignments can be handled by the atlas smoothness and comparison with local diffusion data.
In individual case studies, non-linear registration has successfully been leveraged in this way (Fig. \ref{fig:nrrex}).
However, this is still only possible in an experimental setting and involves significant trial-and-error in determining the appropriate registration input parameters, and it remains the subject of future work to achieve robust generalisation and automation.

\begin{figure}[hb!]
  \centering
  \includegraphics[width=0.9\textwidth]{chapter_3/nrr_gosh_2.png}
  \caption{Example of non-linear registration applied to a GOSH iMRI patient. Left: Intraoperative scan with colour FA map overlaid to enhance \gls{wm} contrast, registered to preoperative scan (rigid registration). Outline of white matter segmentation of preoperative scan is overlaid, demonstrating substantial brain shift away from the craniotomy (*). Arrow highlights shifting of the ipsilateral external capsule. Dotted line indicates position of coronal plane in right image. Right: tractfinder map of bilateral \gls{cst} after non-linear registration between pre- and intraoperative scans, using the Fast Free-Form Deformation algorithm from the NiftyReg package.}
  \label{fig:nrrex}
\end{figure}
